name: Run stdpopsim simulations (chr22)

on:
  workflow_dispatch:
    inputs:
      methods:
        description: "JSON array of methods to train (e.g. [\"BayesR\",\"BayesR-Mix\",\"LDpred2\",\"PRS-CSx\",\"MUSSEL\"])"
        required: false
        default: "[\"BayesR\",\"BayesR-Mix\",\"MUSSEL\"]"
  push:
    paths:
      - "sims/**"
      - ".github/workflows/sim_pops.yml"

env:
  OMP_NUM_THREADS: 4
  MKL_NUM_THREADS: 4
  OPENBLAS_NUM_THREADS: 4
  VECLIB_MAXIMUM_THREADS: 4
  NUMEXPR_NUM_THREADS: 4

jobs:
  # ------------------------------------------------------------------
  # JOB 1: SIMULATE & SPLIT (Generate Data)
  # ------------------------------------------------------------------
  simulate:
    runs-on: ubuntu-latest
    env:
      SIM_CACHE_VERSION: v2
    strategy:
      matrix:
        sim_name: [confounding, portability, sample_imbalance]
    steps:
      - uses: actions/checkout@v4

      - name: Show git revision
        run: |
          git rev-parse HEAD

      - name: Restore simulation cache
        id: sim-cache
        uses: actions/cache/restore@v4
        with:
          path: |
            ${{ matrix.sim_name }}_work/
            ${{ matrix.sim_name }}.tsv
            ${{ matrix.sim_name }}.bed
            ${{ matrix.sim_name }}.bim
            ${{ matrix.sim_name }}.fam
            ${{ matrix.sim_name }}_sites.npz
            ${{ matrix.sim_name }}_pcs.png
          key: sim-${{ runner.os }}-${{ matrix.sim_name }}-${{ env.SIM_CACHE_VERSION }}-${{ hashFiles('sims/sim_pops.py', 'sims/split_data.py', 'sims/plink_utils.py') }}
          restore-keys: |
            sim-${{ runner.os }}-${{ matrix.sim_name }}-${{ env.SIM_CACHE_VERSION }}-

      - name: Cache status
        run: |
          echo "sim cache-hit=${{ steps.sim-cache.outputs.cache-hit }} for ${{ matrix.sim_name }}"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install uv
          uv pip install --system -r sims/requirements.txt

      - name: Install Plink2
        run: |
          wget https://s3.amazonaws.com/plink2-assets/plink2_linux_avx2_20260110.zip -O plink2.zip
          unzip plink2.zip
          sudo mv plink2 /usr/local/bin/
          rm plink2.zip

      - name: Run Simulation ${{ matrix.sim_name }}
        if: steps.sim-cache.outputs.cache-hit != 'true'
        run: |
          set -e
          echo "Running Simulation ${{ matrix.sim_name }}..."
          python sims/sim_pops.py ${{ matrix.sim_name }}

          # sim_pops.py now deletes .trees and .vcf automatically on success
          # Verify they are gone to save space
          if [ -f "${{ matrix.sim_name }}.trees" ]; then
            echo "Error: trees file was not deleted!"
            exit 1
          fi

      - name: Split Data (Train/Test)
        if: steps.sim-cache.outputs.cache-hit != 'true'
        run: |
          set -e
          echo "Splitting Data for ${{ matrix.sim_name }}..."
          python sims/split_data.py ${{ matrix.sim_name }}

      - name: Save simulation cache
        if: ${{ always() && steps.sim-cache.outputs.cache-hit != 'true' }}
        uses: actions/cache/save@v4
        with:
          path: |
            ${{ matrix.sim_name }}_work/
            ${{ matrix.sim_name }}.tsv
            ${{ matrix.sim_name }}.bed
            ${{ matrix.sim_name }}.bim
            ${{ matrix.sim_name }}.fam
            ${{ matrix.sim_name }}_sites.npz
            ${{ matrix.sim_name }}_pcs.png
          key: sim-${{ runner.os }}-${{ matrix.sim_name }}-${{ env.SIM_CACHE_VERSION }}-${{ hashFiles('sims/sim_pops.py', 'sims/split_data.py', 'sims/plink_utils.py') }}

      - name: Upload Simulation Data (Artifact Stream A)
        uses: actions/upload-artifact@v4
        with:
          name: sim-data-${{ matrix.sim_name }}
          path: |
            ${{ matrix.sim_name }}_work/
            ${{ matrix.sim_name }}.tsv
            ${{ matrix.sim_name }}.bed
            ${{ matrix.sim_name }}.bim
            ${{ matrix.sim_name }}.fam
          if-no-files-found: error
          retention-days: 1

  # ------------------------------------------------------------------
  # JOB 2: TRAIN MODELS (Matrix Strategy)
  # ------------------------------------------------------------------
  train:
    needs: simulate
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false # Let other methods finish if one fails
      matrix:
        method: ${{ fromJSON(github.event_name == 'workflow_dispatch' && github.event.inputs.methods || '["BayesR","BayesR-Mix","MUSSEL"]') }}
        sim_name: [confounding, portability, sample_imbalance]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: 'pip'

      - name: Install Python Dependencies
        run: |
          pip install uv
          uv pip install --system -r sims/requirements.txt

      - name: Install Plink2
        run: |
          wget https://s3.amazonaws.com/plink2-assets/plink2_linux_avx2_20260110.zip -O plink2.zip
          unzip plink2.zip
          sudo mv plink2 /usr/local/bin/

      - name: Download Simulation Data
        uses: actions/download-artifact@v4
        with:
          name: sim-data-${{ matrix.sim_name }}
          path: .

      # --- Method Specific Setup ---

      - name: Setup for BayesR
        if: matrix.method == 'BayesR'
        run: |
          mkdir -p gctb_bin
          wget https://cnsgenomics.com/software/gctb/download/gctb_2.03beta_Linux.zip
          unzip gctb_2.03beta_Linux.zip -d gctb_bin
          sudo mv gctb_bin/gctb_2.03beta_Linux/gctb /usr/local/bin/
          chmod +x /usr/local/bin/gctb

      - name: Setup for BayesR-Mix
        if: matrix.method == 'BayesR-Mix'
        run: |
          mkdir -p gctb_bin
          wget https://cnsgenomics.com/software/gctb/download/gctb_2.03beta_Linux.zip
          unzip gctb_2.03beta_Linux.zip -d gctb_bin
          sudo mv gctb_bin/gctb_2.03beta_Linux/gctb /usr/local/bin/
          chmod +x /usr/local/bin/gctb

      - name: Setup for LDpred2
        if: matrix.method == 'LDpred2'
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: '4.3.3'

      - name: Set R library path (for caching)
        if: matrix.method == 'LDpred2'
        run: |
          echo "R_LIBS_USER=$HOME/R/Library" >> $GITHUB_ENV
          mkdir -p "$HOME/R/Library"

      - name: Install system dependencies (LDpred2)
        if: matrix.method == 'LDpred2'
        run: |
          sudo apt-get install -y libcurl4-openssl-dev

      - name: Cache R packages (LDpred2)
        if: matrix.method == 'LDpred2'
        id: rpkgs_cache
        uses: actions/cache/restore@v4
        with:
          path: ~/R/Library
          key: rpkgs-${{ runner.os }}-r43-${{ hashFiles('sims/prs_tools/run_ldpred2.R', 'sims/requirements.txt', '.github/workflows/sim_pops.yml') }}
          restore-keys: |
            rpkgs-${{ runner.os }}-r43-
      
      - name: Install R Dependencies (LDpred2)
        if: matrix.method == 'LDpred2' && steps.rpkgs_cache.outputs.cache-hit != 'true'
        run: |
          Rscript -e 'install.packages(c("bigsnpr","bigstatsr","data.table","R.utils","R.oo","R.methodsS3"), repos="https://cloud.r-project.org")'

      - name: Save R packages cache (LDpred2)
        if: matrix.method == 'LDpred2' && steps.rpkgs_cache.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: ~/R/Library
          key: rpkgs-${{ runner.os }}-r43-${{ hashFiles('sims/prs_tools/run_ldpred2.R', 'sims/requirements.txt', '.github/workflows/sim_pops.yml') }}

      - name: Setup for PRS-CSx
        if: matrix.method == 'PRS-CSx'
        run: |
          set -e
          # PRS-CSx LD reference generation uses PLINK 1.9-style '--r square' output.
          # Install PLINK 1.9 and point PRSCSX_PLINK_EXE at it.
          wget https://s3.amazonaws.com/plink1-assets/plink_linux_x86_64_20250819.zip -O plink19.zip
          unzip -o plink19.zip
          sudo mv -f plink /usr/local/bin/
          chmod +x /usr/local/bin/plink
          rm -f plink19.zip
          plink --version

          command -v plink

          export PRSCSX_PLINK_EXE=/usr/local/bin/plink
          echo "PRSCSX_PLINK_EXE=/usr/local/bin/plink" >> $GITHUB_ENV
          export PRSCSX_LD_METHOD=plink
          export PRSCSX_LD_BFILE=${{ matrix.sim_name }}_work/train
          export PRSCSX_LD_BLOCK_SIZE=300

          # Generate LD reference from training data
          rm -rf prscsx_ref
          mkdir -p prscsx_ref
          python sims/create_ld_ref.py ${{ matrix.sim_name }}_work/train 22 prscsx_ref
          echo "PRS-CSx ref_dir contents:"
          find prscsx_ref -maxdepth 3 -type f -print
          find prscsx_ref -maxdepth 3 -type d -print
          echo "PRSCSX_REF=$PWD/prscsx_ref" >> $GITHUB_ENV
          
          # Install PRS-CSx
          git clone https://github.com/getian107/PRScsx.git
          echo "PRSCSX_PATH=$PWD/PRScsx" >> $GITHUB_ENV

      - name: Setup for MUSSEL
        if: matrix.method == 'MUSSEL'
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: '4.3.3'

      - name: Install MUSSEL R dependencies
        if: matrix.method == 'MUSSEL'
        run: |
          Rscript -e 'install.packages(c("RISCA","optparse","bigreadr","bigsnpr","bigstatsr","bigparallelr","bigmemory","stringr","caret","Rcpp","RcppArmadillo","RcppTN","inline","doMC","foreach","doParallel","data.table","readr","MASS","reshape","parallel","devtools","genio","dplyr","pryr","Matrix","lavaan","xtable","SuperLearner","glmnet","R.utils","R.oo","R.methodsS3"), repos="https://cloud.r-project.org", dependencies=TRUE)'

      - name: Clone MUSSEL repo
        if: matrix.method == 'MUSSEL'
        run: |
          git clone https://github.com/Jin93/MUSSEL.git

      - name: Install MUSSEL R packages (auto-detect)
        if: matrix.method == 'MUSSEL'
        run: |
          cat > /tmp/mussel_pkg_scan.R <<'RSCRIPT'
          files <- Sys.glob("MUSSEL/R/*.R")
          if (length(files) == 0) {
            quit(status = 1)
          }
          txt <- paste(readLines(files, warn = FALSE), collapse = "\n")
          m <- gregexpr("(?:library|require)\\(([^)]+)\\)", txt, perl = TRUE)
          hits <- regmatches(txt, m)[[1]]
          pkgs <- unique(gsub(".*\\(([^)]+)\\).*", "\\1", hits))
          pkgs <- gsub("[\"' ]", "", pkgs)
          pkgs <- pkgs[nzchar(pkgs)]
          base <- c("stats", "utils", "methods", "base", "grDevices", "graphics")
          pkgs <- setdiff(pkgs, base)
          if (length(pkgs) > 0) {
            cat("Installing MUSSEL packages:", paste(pkgs, collapse = ", "), "\n")
            install.packages(pkgs, repos = "https://cloud.r-project.org")
          } else {
            cat("No additional MUSSEL packages detected.\n")
          }
RSCRIPT
          Rscript /tmp/mussel_pkg_scan.R

      - name: Train & Score ${{ matrix.method }}
        run: |
          set -e
          # Ensure R.utils is present for bigsnpr
          if [ "${{ matrix.method }}" == "LDpred2" ]; then
             Rscript -e 'if(!require("R.utils", quietly=TRUE)) install.packages("R.utils", repos="https://cloud.r-project.org")'
          fi

          echo "Training ${{ matrix.method }} on ${{ matrix.sim_name }}..."
          python sims/train_model.py ${{ matrix.sim_name }} ${{ matrix.method }}

      - name: Save R cache (LDpred2)
        if: ${{ always() && matrix.method == 'LDpred2' }}
        run: |
          echo "R cache ready at $R_LIBS_USER"

      - name: Upload Scores
        uses: actions/upload-artifact@v4
        with:
          name: model-scores-${{ matrix.sim_name }}-${{ matrix.method }}
          path: ${{ matrix.sim_name }}_work/*.sscore
          if-no-files-found: error

  # ------------------------------------------------------------------
  # JOB 3: EVALUATE & CALIBRATE
  # ------------------------------------------------------------------
  evaluate:
    needs: [simulate, train]
    if: ${{ always() && needs.simulate.result == 'success' }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        sim_name: [confounding, portability, sample_imbalance]
    steps:
      - uses: actions/checkout@v4

      - name: Set up R for GAM
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: '4.3.3'

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: 'pip'

      - name: Install Python Dependencies
        run: |
          pip install uv
          uv pip install --system -r sims/requirements.txt
          uv pip install --system rpy2

      - name: Install R GAM package
        run: |
          Rscript -e 'install.packages("mgcv", repos="https://cloud.r-project.org")'

      - name: Download Simulation Data
        uses: actions/download-artifact@v4
        with:
          name: sim-data-${{ matrix.sim_name }}
          path: .

      - name: Download BayesR Scores
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: model-scores-${{ matrix.sim_name }}-BayesR
          path: ${{ matrix.sim_name }}_work/
          merge-multiple: true

      - name: Download LDpred2 Scores
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: model-scores-${{ matrix.sim_name }}-LDpred2
          path: ${{ matrix.sim_name }}_work/
          merge-multiple: true

      - name: Download PRS-CSx Scores
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: model-scores-${{ matrix.sim_name }}-PRS-CSx
          path: ${{ matrix.sim_name }}_work/
          merge-multiple: true

      - name: Download BayesR-Mix Scores
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: model-scores-${{ matrix.sim_name }}-BayesR-Mix
          path: ${{ matrix.sim_name }}_work/
          merge-multiple: true

      - name: Calibration Analysis
        run: |
          set -e
          echo "Running Evaluation for Sim ${{ matrix.sim_name }}..."
          python sims/evaluate.py ${{ matrix.sim_name }}

      - name: Upload Results (Stream B)
        uses: actions/upload-artifact@v4
        with:
          name: sim-results-${{ matrix.sim_name }}
          path: |
            ${{ matrix.sim_name }}_metrics.csv
            ${{ matrix.sim_name }}_comparison_*.png
          if-no-files-found: warn

  # ------------------------------------------------------------------
  # JOB 4: REPORT (Consolidate)
  # ------------------------------------------------------------------
  report:
    runs-on: ubuntu-latest
    needs: evaluate
    if: always()
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      
      - name: Install dependencies
        run: |
          pip install uv
          uv pip install --system pandas tabulate
      
      - name: Download all results
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          pattern: sim-results-*
          path: .
          merge-multiple: true

      - name: List downloaded files
        run: |
          echo "Files in current directory:"
          ls -la
          echo "CSV files:"
          ls -la *.csv 2>/dev/null || echo "No CSV files found"
          echo "PNG files:"
          ls -la *.png 2>/dev/null || echo "No PNG files found"
      
      - name: Generate consolidated summary
        run: |
          # Ensure generate_summary.py is robust to missing files if some jobs failed
          python sims/generate_summary.py
      
      - name: Upload summary as artifact
        uses: actions/upload-artifact@v4
        with:
          name: consolidated-summary
          path: summary.md
