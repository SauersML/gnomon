name: Run stdpopsim simulations (chr22)

on:
  workflow_dispatch:
    inputs:
      methods:
        description: "JSON array of methods to train (e.g. [\"BayesR\"])"
        required: false
        default: "[\"BayesR\"]"
  push:
    paths:
      - "sims/**"
      - ".github/workflows/sim_pops.yml"

env:
  OMP_NUM_THREADS: 4
  MKL_NUM_THREADS: 4
  OPENBLAS_NUM_THREADS: 4
  VECLIB_MAXIMUM_THREADS: 4
  NUMEXPR_NUM_THREADS: 4
  TRAIN_METHODS: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.methods || '["BayesR"]' }}

jobs:
  # ------------------------------------------------------------------
  # JOB 1: SIMULATE & SPLIT (Generate Data)
  # ------------------------------------------------------------------
  simulate:
    runs-on: ubuntu-22.04
    env:
      SIM_CACHE_VERSION: v3
    strategy:
      matrix:
        sim_name: [confounding, portability]
    steps:
      - uses: actions/checkout@v4

      - name: Show git revision
        run: |
          git rev-parse HEAD

      - name: Restore simulation cache
        id: sim-cache
        uses: actions/cache/restore@v4
        with:
          path: |
            ${{ matrix.sim_name }}_work/
            ${{ matrix.sim_name }}.tsv
            ${{ matrix.sim_name }}.bed
            ${{ matrix.sim_name }}.bim
            ${{ matrix.sim_name }}.fam
            ${{ matrix.sim_name }}_sites.npz
            ${{ matrix.sim_name }}_pcs.png
          key: sim-${{ runner.os }}-${{ matrix.sim_name }}-${{ env.SIM_CACHE_VERSION }}-${{ hashFiles('sims/sim_pops.py', 'sims/split_data.py', 'sims/plink_utils.py') }}
          restore-keys: |
            sim-${{ runner.os }}-${{ matrix.sim_name }}-${{ env.SIM_CACHE_VERSION }}-

      - name: Cache status
        run: |
          echo "sim cache-hit=${{ steps.sim-cache.outputs.cache-hit }} for ${{ matrix.sim_name }}"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install uv
          uv pip install --system -r sims/requirements.txt

      - name: Install Plink2
        run: |
          wget https://s3.amazonaws.com/plink2-assets/plink2_linux_avx2_20260110.zip -O plink2.zip
          unzip plink2.zip
          sudo mv plink2 /usr/local/bin/
          rm plink2.zip

      - name: Run Simulation ${{ matrix.sim_name }}
        if: steps.sim-cache.outputs.cache-hit != 'true'
        run: |
          set -e
          echo "Running Simulation ${{ matrix.sim_name }}..."
          python sims/sim_pops.py ${{ matrix.sim_name }}

          # sim_pops.py now deletes .trees and .vcf automatically on success
          # Verify they are gone to save space
          if [ -f "${{ matrix.sim_name }}.trees" ]; then
            echo "Error: trees file was not deleted!"
            exit 1
          fi

      - name: Split Data (Train/Test)
        if: steps.sim-cache.outputs.cache-hit != 'true'
        run: |
          set -e
          echo "Splitting Data for ${{ matrix.sim_name }}..."
          python sims/split_data.py ${{ matrix.sim_name }}

      - name: Save simulation cache
        if: ${{ always() && steps.sim-cache.outputs.cache-hit != 'true' }}
        uses: actions/cache/save@v4
        with:
          path: |
            ${{ matrix.sim_name }}_work/
            ${{ matrix.sim_name }}.tsv
            ${{ matrix.sim_name }}.bed
            ${{ matrix.sim_name }}.bim
            ${{ matrix.sim_name }}.fam
            ${{ matrix.sim_name }}_sites.npz
            ${{ matrix.sim_name }}_pcs.png
          key: sim-${{ runner.os }}-${{ matrix.sim_name }}-${{ env.SIM_CACHE_VERSION }}-${{ hashFiles('sims/sim_pops.py', 'sims/split_data.py', 'sims/plink_utils.py') }}

      - name: Upload Simulation Data (Artifact Stream A)
        uses: actions/upload-artifact@v4
        with:
          name: sim-data-${{ matrix.sim_name }}
          path: |
            ${{ matrix.sim_name }}_work/
            ${{ matrix.sim_name }}.tsv
            ${{ matrix.sim_name }}.bed
            ${{ matrix.sim_name }}.bim
            ${{ matrix.sim_name }}.fam
          if-no-files-found: error
          retention-days: 1

  # ------------------------------------------------------------------
  # JOB 2: TRAIN MODELS (Matrix Strategy)
  # ------------------------------------------------------------------
  train:
    needs: simulate
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false # Let other methods finish if one fails
      matrix:
        method: ${{ fromJSON(github.event_name == 'workflow_dispatch' && github.event.inputs.methods || '["BayesR"]') }}
        sim_name: [confounding, portability]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: 'pip'

      - name: Install Python Dependencies
        run: |
          pip install uv
          uv pip install --system -r sims/requirements.txt
          uv pip install --system pgscatalog-calc

      - name: Install Plink2
        run: |
          wget https://s3.amazonaws.com/plink2-assets/plink2_linux_avx2_20260110.zip -O plink2.zip
          unzip plink2.zip
          sudo mv plink2 /usr/local/bin/

      - name: Download Simulation Data
        uses: actions/download-artifact@v4
        with:
          name: sim-data-${{ matrix.sim_name }}
          path: .

      # --- Method Specific Setup ---

      - name: Setup for BayesR
        if: matrix.method == 'BayesR'
        run: |
          mkdir -p gctb_bin
          wget https://cnsgenomics.com/software/gctb/download/gctb_2.03beta_Linux.zip
          unzip gctb_2.03beta_Linux.zip -d gctb_bin
          sudo mv gctb_bin/gctb_2.03beta_Linux/gctb /usr/local/bin/
          chmod +x /usr/local/bin/gctb



      - name: Train & Score ${{ matrix.method }}
        run: |
          set -e
          echo "Training ${{ matrix.method }} on ${{ matrix.sim_name }}..."
          python sims/train_model.py ${{ matrix.sim_name }} ${{ matrix.method }}

      - name: Upload Scores
        uses: actions/upload-artifact@v4
        with:
          name: model-scores-${{ matrix.sim_name }}-${{ matrix.method }}
          path: ${{ matrix.sim_name }}_work/*.sscore
          if-no-files-found: error

  # ------------------------------------------------------------------
  # JOB 3: EVALUATE & CALIBRATE
  # ------------------------------------------------------------------
  evaluate:
    needs: [simulate, train]
    if: ${{ always() && needs.simulate.result == 'success' }}
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        sim_name: [confounding, portability]
    steps:
      - uses: actions/checkout@v4

      - name: Set up R for GAM
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: '4.4.2'

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: 'pip'

      - name: Install Python Dependencies
        run: |
          pip install uv
          uv pip install --system -r sims/requirements.txt
          uv pip install --system rpy2
          uv pip install --system pgscatalog-calc

      - name: Install R GAM package
        run: |
          Rscript -e 'install.packages("mgcv", repos="https://cloud.r-project.org")'

      - name: Download Simulation Data
        uses: actions/download-artifact@v4
        with:
          name: sim-data-${{ matrix.sim_name }}
          path: .

      - name: Download BayesR Scores
        if: ${{ contains(fromJSON(env.TRAIN_METHODS), 'BayesR') }}
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: model-scores-${{ matrix.sim_name }}-BayesR
          path: ${{ matrix.sim_name }}_work/
          merge-multiple: true



      - name: Install gnomon (binary release)
        run: |
          bash install.sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Calibration Analysis
        run: |
          set -e
          echo "Running Evaluation for Sim ${{ matrix.sim_name }}..."
          python sims/evaluate.py ${{ matrix.sim_name }}

      - name: Upload Results (Stream B)
        uses: actions/upload-artifact@v4
        with:
          name: sim-results-${{ matrix.sim_name }}
          path: |
            ${{ matrix.sim_name }}_metrics.csv
            ${{ matrix.sim_name }}_comparison_*.png
          if-no-files-found: warn

  # ------------------------------------------------------------------
  # JOB 4: REPORT (Consolidate)
  # ------------------------------------------------------------------
  report:
    runs-on: ubuntu-22.04
    needs: evaluate
    if: always()
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      
      - name: Install dependencies
        run: |
          pip install uv
          uv pip install --system -r sims/requirements.txt
          uv pip install --system pandas tabulate
          uv pip install --system pgscatalog-calc

      - name: Install gnomon (binary release)
        run: |
          bash install.sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Download all results
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          pattern: sim-results-*
          path: .
          merge-multiple: true

      - name: List downloaded files
        run: |
          echo "Files in current directory:"
          ls -la
          echo "CSV files:"
          ls -la *.csv 2>/dev/null || echo "No CSV files found"
          echo "PNG files:"
          ls -la *.png 2>/dev/null || echo "No PNG files found"
      
      - name: Generate consolidated summary
        run: |
          # Ensure generate_summary.py is robust to missing files if some jobs failed
          python sims/generate_summary.py

      - name: Aggregate metrics & p-values
        run: |
          python sims/aggregate_results.py

      - name: Upload summary as artifact
        uses: actions/upload-artifact@v4
        with:
          name: consolidated-summary
          path: |
            summary.md
            all_methods_metrics.tsv
            all_methods_pvalues.png

  # ------------------------------------------------------------------
  # JOB 5: TWO-POP SIMS (divergence, bottleneck)
  # ------------------------------------------------------------------
  two_pop_simulate_train_eval:
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        sim_name: [divergence, bottleneck]
        divergence_gens: [0, 20, 50, 100, 500, 1000, 5000, 10000]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Set up R for GAM
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: "4.4.2"

      - name: Install Python Dependencies
        run: |
          pip install uv
          uv pip install --system -r sims/requirements.txt
          uv pip install --system rpy2

      - name: Install R GAM package
        run: |
          Rscript -e 'install.packages("mgcv", repos="https://cloud.r-project.org")'

      - name: Install Plink2
        run: |
          wget https://s3.amazonaws.com/plink2-assets/plink2_linux_avx2_20260110.zip -O plink2.zip
          unzip plink2.zip
          sudo mv plink2 /usr/local/bin/
          rm plink2.zip

      - name: Install GCTB (BayesR)
        run: |
          mkdir -p gctb_bin
          wget https://cnsgenomics.com/software/gctb/download/gctb_2.03beta_Linux.zip
          unzip gctb_2.03beta_Linux.zip -d gctb_bin
          sudo mv gctb_bin/gctb_2.03beta_Linux/gctb /usr/local/bin/
          chmod +x /usr/local/bin/gctb

      - name: Install gnomon (binary release)
        run: |
          bash install.sh

      - name: Run simulation
        run: |
          python sims/sim_two_pop.py ${{ matrix.sim_name }} ${{ matrix.divergence_gens }}

      - name: Split data
        run: |
          python sims/split_data.py ${{ matrix.sim_name }}_g${{ matrix.divergence_gens }}

      - name: Train BayesR
        run: |
          python sims/train_model.py ${{ matrix.sim_name }}_g${{ matrix.divergence_gens }} BayesR

      - name: Evaluate calibration methods
        run: |
          python sims/evaluate.py ${{ matrix.sim_name }}_g${{ matrix.divergence_gens }}

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: two-pop-${{ matrix.sim_name }}-g${{ matrix.divergence_gens }}
          path: |
            ${{ matrix.sim_name }}_g${{ matrix.divergence_gens }}_metrics.csv
            ${{ matrix.sim_name }}_g${{ matrix.divergence_gens }}_comparison_roc.png
            ${{ matrix.sim_name }}_g${{ matrix.divergence_gens }}_comparison_calibration.png
            ${{ matrix.sim_name }}_g${{ matrix.divergence_gens }}_comparison_auc.png
            ${{ matrix.sim_name }}_g${{ matrix.divergence_gens }}_pcs.png
          if-no-files-found: error

  two_pop_plot_auc:
    needs: two_pop_simulate_train_eval
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install Python Dependencies
        run: |
          pip install uv
          uv pip install --system pandas matplotlib

      - name: Download metrics artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: two-pop-*
          path: .
          merge-multiple: true

      - name: Build divergence/bottleneck AUC plot
        run: |
          python sims/plot_divergence_auc.py --method "Raw PGS"

      - name: Build two-pop PC mega plot
        run: |
          python sims/plot_two_pop_pcs_grid.py

      - name: Upload AUC plot
        uses: actions/upload-artifact@v4
        with:
          name: two-pop-auc-plot
          path: |
            divergence_bottleneck_auc.csv
            divergence_bottleneck_auc.png
            two_pop_pcs_mega.png
          if-no-files-found: error
