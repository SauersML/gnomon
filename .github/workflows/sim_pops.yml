name: Run stdpopsim simulations (chr22)

on:
  workflow_dispatch:
  push:
    paths:
      - "sims/**"
      - ".github/workflows/sim_pops.yml"

env:
  OMP_NUM_THREADS: 4
  MKL_NUM_THREADS: 4
  OPENBLAS_NUM_THREADS: 4
  VECLIB_MAXIMUM_THREADS: 4
  NUMEXPR_NUM_THREADS: 4

jobs:
  # ------------------------------------------------------------------
  # JOB 1: SIMULATE & SPLIT (Generate Data)
  # ------------------------------------------------------------------
  simulate:
    runs-on: ubuntu-latest
    env:
      SIM_CACHE_VERSION: v1
    strategy:
      matrix:
        sim: [1, 2, 3] # Adjusted to match original var name if possible, or use sim_id
    steps:
      - uses: actions/checkout@v4

      - name: Show git revision
        run: |
          git rev-parse HEAD

      - name: Restore simulation cache
        id: sim-cache
        uses: actions/cache/restore@v4
        with:
          path: |
            sim${{ matrix.sim }}_work/
            sim${{ matrix.sim }}.tsv
            sim${{ matrix.sim }}.bed
            sim${{ matrix.sim }}.bim
            sim${{ matrix.sim }}.fam
            sim${{ matrix.sim }}_sites.npz
            sim${{ matrix.sim }}_pcs.png
          key: sim-${{ runner.os }}-${{ matrix.sim }}-${{ env.SIM_CACHE_VERSION }}-${{ hashFiles('sims/sim_pops.py', 'sims/split_data.py', 'sims/plink_utils.py') }}
          restore-keys: |
            sim-${{ runner.os }}-${{ matrix.sim }}-${{ env.SIM_CACHE_VERSION }}-

      - name: Cache status
        run: |
          echo "sim cache-hit=${{ steps.sim-cache.outputs.cache-hit }}"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install uv
          uv pip install --system -r sims/requirements.txt

      - name: Install Plink2
        run: |
          wget https://s3.amazonaws.com/plink2-assets/plink2_linux_avx2_20260110.zip -O plink2.zip
          unzip plink2.zip
          sudo mv plink2 /usr/local/bin/
          rm plink2.zip

      - name: Run Simulation ${{ matrix.sim }}
        if: steps.sim-cache.outputs.cache-hit != 'true'
        run: |
          set -e
          echo "Running Simulation ${{ matrix.sim }}..."
          python sims/sim_pops.py ${{ matrix.sim }}
          
          # sim_pops.py now deletes .trees and .vcf automatically on success
          # Verify they are gone to save space
          if [ -f "sim${{ matrix.sim }}.trees" ]; then
            echo "Error: trees file was not deleted!"
            exit 1
          fi

      - name: Split Data (Train/Test)
        if: steps.sim-cache.outputs.cache-hit != 'true'
        run: |
          set -e
          echo "Splitting Data for Sim ${{ matrix.sim }}..."
          python sims/split_data.py ${{ matrix.sim }}

      - name: Save simulation cache
        if: ${{ always() && steps.sim-cache.outputs.cache-hit != 'true' }}
        uses: actions/cache/save@v4
        with:
          path: |
            sim${{ matrix.sim }}_work/
            sim${{ matrix.sim }}.tsv
            sim${{ matrix.sim }}.bed
            sim${{ matrix.sim }}.bim
            sim${{ matrix.sim }}.fam
            sim${{ matrix.sim }}_sites.npz
            sim${{ matrix.sim }}_pcs.png
          key: sim-${{ runner.os }}-${{ matrix.sim }}-${{ env.SIM_CACHE_VERSION }}-${{ hashFiles('sims/sim_pops.py', 'sims/split_data.py', 'sims/plink_utils.py') }}

      - name: Upload Simulation Data (Artifact Stream A)
        uses: actions/upload-artifact@v4
        with:
          name: sim-data-${{ matrix.sim }}
          path: |
            sim${{ matrix.sim }}_work/
            sim${{ matrix.sim }}.tsv
          if-no-files-found: error
          retention-days: 1

  # ------------------------------------------------------------------
  # JOB 2: TRAIN MODELS (Matrix Strategy)
  # ------------------------------------------------------------------
  train:
    needs: simulate
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false # Let other methods finish if one fails
      matrix:
        sim: [1, 2, 3]
        method: [BayesR, LDpred2, PRS-CSx]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: 'pip'

      - name: Install Python Dependencies
        run: |
          pip install uv
          uv pip install --system -r sims/requirements.txt

      - name: Install Plink2
        run: |
          wget https://s3.amazonaws.com/plink2-assets/plink2_linux_avx2_20260110.zip -O plink2.zip
          unzip plink2.zip
          sudo mv plink2 /usr/local/bin/

      - name: Download Simulation Data
        uses: actions/download-artifact@v4
        with:
          name: sim-data-${{ matrix.sim }}

      # --- Method Specific Setup ---
      
      - name: Setup for BayesR
        if: matrix.method == 'BayesR'
        run: |
          mkdir -p gctb_bin
          wget https://cnsgenomics.com/software/gctb/download/gctb_2.03beta_Linux.zip
          unzip gctb_2.03beta_Linux.zip -d gctb_bin
          sudo mv gctb_bin/gctb_2.03beta_Linux/gctb /usr/local/bin/
          chmod +x /usr/local/bin/gctb

      - name: Setup for LDpred2
        if: matrix.method == 'LDpred2'
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: '4.3.3'

      - name: Set R library path (for caching)
        if: matrix.method == 'LDpred2'
        run: |
          echo "R_LIBS_USER=$HOME/R/Library" >> $GITHUB_ENV
          mkdir -p "$HOME/R/Library"

      - name: Install system dependencies (LDpred2)
        if: matrix.method == 'LDpred2'
        run: |
          sudo apt-get install -y libcurl4-openssl-dev

      - name: Cache R packages (LDpred2)
        if: matrix.method == 'LDpred2'
        id: rpkgs_cache
        uses: actions/cache/restore@v4
        with:
          path: ~/R/Library
          key: rpkgs-${{ runner.os }}-r43-${{ hashFiles('sims/prs_tools/run_ldpred2.R', 'sims/requirements.txt', '.github/workflows/sim_pops.yml') }}
          restore-keys: |
            rpkgs-${{ runner.os }}-r43-
      
      - name: Install R Dependencies (LDpred2)
        if: matrix.method == 'LDpred2' && steps.rpkgs_cache.outputs.cache-hit != 'true'
        run: |
          Rscript -e 'install.packages(c("bigsnpr","bigstatsr","data.table","R.utils","R.oo","R.methodsS3"), repos="https://cloud.r-project.org")'

      - name: Save R packages cache (LDpred2)
        if: matrix.method == 'LDpred2' && steps.rpkgs_cache.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: ~/R/Library
          key: rpkgs-${{ runner.os }}-r43-${{ hashFiles('sims/prs_tools/run_ldpred2.R', 'sims/requirements.txt', '.github/workflows/sim_pops.yml') }}

      - name: Setup for PRS-CSx
        if: matrix.method == 'PRS-CSx'
        run: |
          set -e
          # PRS-CSx LD reference generation uses PLINK 1.9-style '--r square' output.
          # Install PLINK 1.9 and point PRSCSX_PLINK_EXE at it.
          wget https://s3.amazonaws.com/plink1-assets/plink_linux_x86_64_20250819.zip -O plink19.zip
          unzip -o plink19.zip
          sudo mv -f plink /usr/local/bin/
          chmod +x /usr/local/bin/plink
          rm -f plink19.zip
          plink --version

          command -v plink

          export PRSCSX_PLINK_EXE=/usr/local/bin/plink
          echo "PRSCSX_PLINK_EXE=/usr/local/bin/plink" >> $GITHUB_ENV
          export PRSCSX_LD_METHOD=plink
          export PRSCSX_LD_BFILE=sim${{ matrix.sim }}_work/train
          export PRSCSX_LD_BLOCK_SIZE=300

          # Generate LD reference from training data
          rm -rf prscsx_ref
          mkdir -p prscsx_ref
          python sims/create_ld_ref.py sim${{ matrix.sim }}_work/train 22 prscsx_ref
          echo "PRS-CSx ref_dir contents:" 
          find prscsx_ref -maxdepth 3 -type f -print
          find prscsx_ref -maxdepth 3 -type d -print
          echo "PRSCSX_REF=$PWD/prscsx_ref" >> $GITHUB_ENV
          
          # Install PRS-CSx
          git clone https://github.com/getian107/PRScsx.git
          echo "PRSCSX_PATH=$PWD/PRScsx" >> $GITHUB_ENV

      - name: Train & Score ${{ matrix.method }}
        run: |
          set -e
          # Ensure R.utils is present for bigsnpr
          if [ "${{ matrix.method }}" == "LDpred2" ]; then
             Rscript -e 'if(!require("R.utils", quietly=TRUE)) install.packages("R.utils", repos="https://cloud.r-project.org")'
          fi
          
          echo "Training ${{ matrix.method }} on Sim ${{ matrix.sim }}..."
          python sims/train_model.py ${{ matrix.sim }} ${{ matrix.method }}

      - name: Save R cache (LDpred2)
        if: ${{ always() && matrix.method == 'LDpred2' }}
        run: |
          echo "R cache ready at $R_LIBS_USER"

      - name: Upload Scores
        uses: actions/upload-artifact@v4
        with:
          name: model-scores-${{ matrix.sim }}-${{ matrix.method }}
          path: sim${{ matrix.sim }}_work/*.sscore
          if-no-files-found: error

  # ------------------------------------------------------------------
  # JOB 3: EVALUATE & CALIBRATE
  # ------------------------------------------------------------------
  evaluate:
    needs: train
    runs-on: ubuntu-latest
    strategy:
      matrix:
        sim: [1, 2, 3]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: 'pip'

      - name: Install Python Dependencies
        run: |
          pip install uv
          uv pip install --system -r sims/requirements.txt

      - name: Download Simulation Data
        uses: actions/download-artifact@v4
        with:
          name: sim-data-${{ matrix.sim }}

      - name: Download BayesR Scores
        uses: actions/download-artifact@v4
        with:
          name: model-scores-${{ matrix.sim }}-BayesR
          path: sim${{ matrix.sim }}_work/
          merge-multiple: true

      - name: Download LDpred2 Scores
        uses: actions/download-artifact@v4
        with:
          name: model-scores-${{ matrix.sim }}-LDpred2
          path: sim${{ matrix.sim }}_work/
          merge-multiple: true

      - name: Download PRS-CSx Scores
        uses: actions/download-artifact@v4
        with:
          name: model-scores-${{ matrix.sim }}-PRS-CSx
          path: sim${{ matrix.sim }}_work/
          merge-multiple: true

      - name: Calibration Analysis
        run: |
          set -e
          echo "Running Evaluation for Sim ${{ matrix.sim }}..."
          python sims/evaluate.py ${{ matrix.sim }}

      - name: Upload Results (Stream B)
        uses: actions/upload-artifact@v4
        with:
          name: sim-results-${{ matrix.sim }}
          path: |
            sim${{ matrix.sim }}_metrics.csv
            sim${{ matrix.sim }}_comparison_*.png
          if-no-files-found: error

  # ------------------------------------------------------------------
  # JOB 4: REPORT (Consolidate)
  # ------------------------------------------------------------------
  report:
    runs-on: ubuntu-latest
    needs: evaluate
    if: always()
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      
      - name: Install dependencies
        run: |
          pip install uv
          uv pip install --system pandas tabulate
      
      - name: Download all results
        uses: actions/download-artifact@v4
        with:
          pattern: sim-results-*
          path: artifacts
          merge-multiple: true
      
      - name: Copy artifacts to working directory
        run: |
          # Flatten artifacts if needed, but merge-multiple should handle it?
          # If merge-multiple: true, files are in 'artifacts/' root.
          cp artifacts/*.csv . || true
          cp artifacts/*.png . || true
          ls -la
      
      - name: Generate consolidated summary
        run: |
          # Ensure generate_summary.py is robust to missing files if some jobs failed
          python sims/generate_summary.py
      
      - name: Upload summary as artifact
        uses: actions/upload-artifact@v4
        with:
          name: consolidated-summary
          path: summary.md
