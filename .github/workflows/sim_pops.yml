name: Run stdpopsim simulations (chr22)

on:
  workflow_dispatch:
    inputs:
      methods:
        description: "JSON array of methods to train (e.g. [\"BayesR\"])"
        required: false
        default: "[\"BayesR\"]"
      enable_gnomon:
        description: "Enable GAM-gnomon calibration (true/false)"
        required: false
        default: "false"
      portability_only:
        description: "Run only portability simulation/analysis (skip confounding and two-pop jobs)"
        required: false
        type: boolean
        default: false
  schedule:
    - cron: "0 7 * * *"

env:
  OMP_NUM_THREADS: 4
  MKL_NUM_THREADS: 4
  OPENBLAS_NUM_THREADS: 4
  VECLIB_MAXIMUM_THREADS: 4
  NUMEXPR_NUM_THREADS: 4
  ACTIONS_TOOLKIT_HTTP_TIMEOUT: 300
  ACTIONS_TOOLKIT_HTTP_RETRY: 5
  GIT_HTTP_LOW_SPEED_LIMIT: 1000
  GIT_HTTP_LOW_SPEED_TIME: 60
  TOOL_CACHE_VERSION: v1
  TRAIN_METHODS: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.methods || '["BayesR"]' }}
  ENABLE_GNOMON: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.enable_gnomon || 'false' }}

jobs:
  # ------------------------------------------------------------------
  # JOB 0: TOOL CACHE (Populate once, then reuse)
  # ------------------------------------------------------------------
  tool_cache:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout (primary)
        id: checkout-primary
        continue-on-error: true
        uses: actions/checkout@v4

      - name: Checkout (retry)
        if: steps.checkout-primary.outcome != 'success'
        uses: actions/checkout@v4

      - name: Restore tool cache
        id: tools-cache
        uses: actions/cache/restore@v4
        with:
          path: |
            ~/.cache/uv
            ~/.cache/pip
            /usr/local/bin/plink2
            /usr/local/bin/gctb
          key: tools-${{ runner.os }}-${{ env.TOOL_CACHE_VERSION }}

      - name: Set up Python
        if: steps.tools-cache.outputs.cache-hit != 'true'
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: 'pip'

      - name: Install R (apt)
        if: steps.tools-cache.outputs.cache-hit != 'true'
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends r-base

      - name: Install base dependencies
        if: steps.tools-cache.outputs.cache-hit != 'true'
        run: |
          set -euo pipefail
          pip install uv
          uv pip install --system -r sims/requirements.txt
          uv pip install --system rpy2
          for i in 1 2 3; do
            Rscript -e 'install.packages("mgcv", repos="https://cloud.r-project.org")' && break
            echo "mgcv install attempt $i failed; retrying..."
            sleep $((i*10))
          done

      - name: Install Plink2
        if: steps.tools-cache.outputs.cache-hit != 'true'
        run: |
          wget https://s3.amazonaws.com/plink2-assets/plink2_linux_avx2_20260110.zip -O plink2.zip
          unzip plink2.zip
          sudo mv plink2 /usr/local/bin/
          rm plink2.zip

      - name: Install GCTB (BayesR)
        if: steps.tools-cache.outputs.cache-hit != 'true'
        run: |
          mkdir -p gctb_bin
          wget https://cnsgenomics.com/software/gctb/download/gctb_2.03beta_Linux.zip
          unzip gctb_2.03beta_Linux.zip -d gctb_bin
          sudo mv gctb_bin/gctb_2.03beta_Linux/gctb /usr/local/bin/
          chmod +x /usr/local/bin/gctb

      - name: Save tool cache
        if: ${{ always() && steps.tools-cache.outputs.cache-hit != 'true' }}
        uses: actions/cache/save@v4
        with:
          path: |
            ~/.cache/uv
            ~/.cache/pip
            /usr/local/bin/plink2
            /usr/local/bin/gctb
          key: tools-${{ runner.os }}-${{ env.TOOL_CACHE_VERSION }}

  # ------------------------------------------------------------------
  # JOB 1: SIMULATE & SPLIT (Generate Data)
  # ------------------------------------------------------------------
  simulate:
    needs: tool_cache
    runs-on: ubuntu-22.04
    env:
      SIM_CACHE_VERSION: v3
    strategy:
      fail-fast: false
      matrix:
        sim_name: ${{ fromJSON(github.event_name == 'workflow_dispatch' && github.event.inputs.portability_only == 'true' && '["portability"]' || '["confounding","portability"]') }}
        seed: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15]
        exclude:
          - sim_name: confounding
            seed: 6
          - sim_name: confounding
            seed: 7
          - sim_name: confounding
            seed: 8
          - sim_name: confounding
            seed: 9
          - sim_name: confounding
            seed: 10
          - sim_name: confounding
            seed: 11
          - sim_name: confounding
            seed: 12
          - sim_name: confounding
            seed: 13
          - sim_name: confounding
            seed: 14
          - sim_name: confounding
            seed: 15
    steps:
      - uses: actions/checkout@v4

      - name: Reclaim disk space
        run: |
          set -euo pipefail
          echo "Disk before cleanup:"
          df -h
          if [ -d /home/runner/actions-runner/cached/_diag ]; then
            echo "Cleaning runner diag logs..."
            find /home/runner/actions-runner/cached/_diag -type f -name "*.log*" -delete || true
          fi
          if [ -d /home/runner/actions-runner/cached/_work/_temp ]; then
            echo "Cleaning runner temp workspace..."
            find /home/runner/actions-runner/cached/_work/_temp -mindepth 1 -maxdepth 1 -exec rm -rf {} + || true
          fi
          sudo rm -rf /usr/share/dotnet || true
          sudo rm -rf /opt/ghc || true
          sudo rm -rf /usr/local/lib/android || true
          sudo rm -rf /opt/hostedtoolcache/CodeQL || true
          sudo apt-get clean || true
          echo "Disk after cleanup:"
          df -h

      - name: Restore tool cache
        id: tools-cache
        uses: actions/cache/restore@v4
        with:
          path: |
            ~/.cache/uv
            ~/.cache/pip
            /usr/local/bin/plink2
            /usr/local/bin/gctb
          key: tools-${{ runner.os }}-${{ env.TOOL_CACHE_VERSION }}
      
      - name: Show git revision
        run: |
          git rev-parse HEAD

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install uv
          uv pip install --system -r sims/requirements.txt

      - name: Install Plink2
        run: |
          wget https://s3.amazonaws.com/plink2-assets/plink2_linux_avx2_20260110.zip -O plink2.zip
          unzip plink2.zip
          sudo mv plink2 /usr/local/bin/
          rm plink2.zip

      - name: Run Simulation ${{ matrix.sim_name }}
        run: |
          set -euo pipefail
          echo "Running Simulation ${{ matrix.sim_name }} (seed=${{ matrix.seed }})..."
          prefix="${{ matrix.sim_name }}_s${{ matrix.seed }}"
          echo "Disk before simulation:"
          df -h

          # Heartbeat diagnostics while simulation is running.
          # Keep output lightweight to avoid log bloat while still surfacing
          # impending disk exhaustion before an abrupt runner crash.
          _diag_heartbeat() {
            while true; do
              echo "---- heartbeat $(date -u +%Y-%m-%dT%H:%M:%SZ) ${prefix} ----"
              df -h / /home || true
              du -sh . 2>/dev/null || true
              find . -maxdepth 2 -type f -exec ls -lh {} + 2>/dev/null | sort -k5 -h | tail -n 12 || true
              sleep 120
            done
          }

          ok=0
          for attempt in 1 2 3; do
            echo "Simulation attempt ${attempt}/3 for ${prefix}"
            rm -f "${prefix}.trees" "${prefix}.vcf" "${prefix}.cm"
            _diag_heartbeat &
            HB_PID=$!
            if python sims/sim_pops.py ${{ matrix.sim_name }} ${{ matrix.seed }} --force; then
              kill "$HB_PID" 2>/dev/null || true
              wait "$HB_PID" 2>/dev/null || true
              ok=1
              break
            fi
            kill "$HB_PID" 2>/dev/null || true
            wait "$HB_PID" 2>/dev/null || true
            echo "Simulation attempt ${attempt} failed for ${prefix}"
            echo "Debug disk usage after failed attempt:"
            df -h || true
            du -sh ./* 2>/dev/null | sort -h | tail -n 30 || true
            sleep $((attempt*20))
          done
          if [ "$ok" -ne 1 ]; then
            echo "Simulation failed after 3 attempts for ${prefix}"
            exit 1
          fi

          # sim_pops.py now deletes .trees and .vcf automatically on success
          # Verify they are gone to save space
          if [ -f "${{ matrix.sim_name }}_s${{ matrix.seed }}.trees" ]; then
            echo "Error: trees file was not deleted!"
            exit 1
          fi

      - name: Split Data (Train/Test)
        run: |
          set -e
          echo "Splitting Data for ${{ matrix.sim_name }} (seed=${{ matrix.seed }})..."
          python sims/split_data.py ${{ matrix.sim_name }}_s${{ matrix.seed }}

      - name: Remove large source PLINK files (keep split train/test only)
        run: |
          set -euo pipefail
          prefix="${{ matrix.sim_name }}_s${{ matrix.seed }}"
          rm -f "${prefix}.bed" "${prefix}.bim" "${prefix}.fam"
          rm -f "${prefix}_sites.npz" "${prefix}_pcs.png"
          echo "Disk after cleanup:"
          df -h

      - name: Upload Simulation Data (Artifact Stream A)
        if: ${{ always() }}
        id: upload-sim-data-primary
        continue-on-error: true
        uses: actions/upload-artifact@v4
        with:
          name: sim-data-${{ matrix.sim_name }}-s${{ matrix.seed }}
          path: |
            ${{ matrix.sim_name }}_s${{ matrix.seed }}_work/
            ${{ matrix.sim_name }}_s${{ matrix.seed }}.tsv
          if-no-files-found: warn
          retention-days: 1

      - name: Retry upload simulation data
        if: ${{ always() && steps.upload-sim-data-primary.outcome != 'success' }}
        uses: actions/upload-artifact@v4
        with:
          name: sim-data-${{ matrix.sim_name }}-s${{ matrix.seed }}
          path: |
            ${{ matrix.sim_name }}_s${{ matrix.seed }}_work/
            ${{ matrix.sim_name }}_s${{ matrix.seed }}.tsv
          if-no-files-found: warn
          retention-days: 1

      - name: Upload simulate diagnostics
        if: ${{ always() }}
        continue-on-error: true
        run: |
          set -euo pipefail
          {
            echo "sim_name=${{ matrix.sim_name }}"
            echo "seed=${{ matrix.seed }}"
            echo "date_utc=$(date -u +%Y-%m-%dT%H:%M:%SZ)"
            echo ""
            echo "== disk =="
            df -h
            echo ""
            echo "== top files in workspace =="
            du -sh ./* 2>/dev/null | sort -h | tail -n 40
            echo ""
            echo "== runner diag dir =="
            ls -lah /home/runner/actions-runner/cached/_diag 2>/dev/null || true
          } > "simulate_${{ matrix.sim_name }}_s${{ matrix.seed }}_debug.txt"

      - name: Upload simulate diagnostics artifact
        if: ${{ always() }}
        continue-on-error: true
        uses: actions/upload-artifact@v4
        with:
          name: sim-debug-${{ matrix.sim_name }}-s${{ matrix.seed }}
          path: simulate_${{ matrix.sim_name }}_s${{ matrix.seed }}_debug.txt
          if-no-files-found: warn

      - name: Save tool cache
        if: ${{ always() && steps.tools-cache.outputs.cache-hit != 'true' }}
        uses: actions/cache/save@v4
        with:
          path: |
            ~/.cache/uv
            ~/.cache/pip
            /usr/local/bin/plink2
            /usr/local/bin/gctb
          key: tools-${{ runner.os }}-${{ env.TOOL_CACHE_VERSION }}

  # ------------------------------------------------------------------
  # JOB 2: TRAIN MODELS (Matrix Strategy)
  # ------------------------------------------------------------------
  train:
    needs: [tool_cache, simulate]
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false # Let other methods finish if one fails
      matrix:
        method: ${{ fromJSON(github.event_name == 'workflow_dispatch' && github.event.inputs.methods || '["BayesR"]') }}
        sim_name: ${{ fromJSON(github.event_name == 'workflow_dispatch' && github.event.inputs.portability_only == 'true' && '["portability"]' || '["confounding","portability"]') }}
        seed: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15]
        exclude:
          - sim_name: confounding
            seed: 6
          - sim_name: confounding
            seed: 7
          - sim_name: confounding
            seed: 8
          - sim_name: confounding
            seed: 9
          - sim_name: confounding
            seed: 10
          - sim_name: confounding
            seed: 11
          - sim_name: confounding
            seed: 12
          - sim_name: confounding
            seed: 13
          - sim_name: confounding
            seed: 14
          - sim_name: confounding
            seed: 15
    steps:
      - uses: actions/checkout@v4

      - name: Restore tool cache
        id: tools-cache
        uses: actions/cache/restore@v4
        with:
          path: |
            ~/.cache/uv
            ~/.cache/pip
            /usr/local/bin/plink2
            /usr/local/bin/gctb
          key: tools-${{ runner.os }}-${{ env.TOOL_CACHE_VERSION }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: 'pip'

      - name: Install Python Dependencies
        run: |
          pip install uv
          uv pip install --system -r sims/requirements.txt
          uv pip install --system pgscatalog-calc

      - name: Install Plink2
        run: |
          wget https://s3.amazonaws.com/plink2-assets/plink2_linux_avx2_20260110.zip -O plink2.zip
          unzip plink2.zip
          sudo mv plink2 /usr/local/bin/

      - name: Download Simulation Data
        uses: actions/download-artifact@v4
        with:
          name: sim-data-${{ matrix.sim_name }}-s${{ matrix.seed }}
          path: .

      - name: Restore model score cache
        id: score-cache
        uses: actions/cache/restore@v4
        with:
          path: |
            ${{ matrix.sim_name }}_s${{ matrix.seed }}_work/*.sscore
          key: score-${{ runner.os }}-${{ matrix.sim_name }}-s${{ matrix.seed }}-${{ matrix.method }}-${{ hashFiles('sims/train_model.py', 'sims/plink_utils.py', 'sims/methods/**', 'sims/metrics.py') }}
          restore-keys: |
            score-${{ runner.os }}-${{ matrix.sim_name }}-s${{ matrix.seed }}-${{ matrix.method }}-

      # --- Method Specific Setup ---

      - name: Setup for BayesR
        if: matrix.method == 'BayesR'
        run: |
          mkdir -p gctb_bin
          wget https://cnsgenomics.com/software/gctb/download/gctb_2.03beta_Linux.zip
          unzip gctb_2.03beta_Linux.zip -d gctb_bin
          sudo mv gctb_bin/gctb_2.03beta_Linux/gctb /usr/local/bin/
          chmod +x /usr/local/bin/gctb



      - name: Train & Score ${{ matrix.method }}
        if: steps.score-cache.outputs.cache-hit != 'true'
        run: |
          set -e
          echo "Training ${{ matrix.method }} on ${{ matrix.sim_name }} (seed=${{ matrix.seed }})..."
          python sims/train_model.py ${{ matrix.sim_name }}_s${{ matrix.seed }} ${{ matrix.method }}

      - name: Save model score cache
        if: ${{ always() && steps.score-cache.outputs.cache-hit != 'true' }}
        uses: actions/cache/save@v4
        with:
          path: |
            ${{ matrix.sim_name }}_s${{ matrix.seed }}_work/*.sscore
          key: score-${{ runner.os }}-${{ matrix.sim_name }}-s${{ matrix.seed }}-${{ matrix.method }}-${{ hashFiles('sims/train_model.py', 'sims/plink_utils.py', 'sims/methods/**', 'sims/metrics.py') }}

      - name: Upload Scores
        id: upload-scores-primary
        continue-on-error: true
        uses: actions/upload-artifact@v4
        with:
          name: model-scores-${{ matrix.sim_name }}-s${{ matrix.seed }}-${{ matrix.method }}
          path: ${{ matrix.sim_name }}_s${{ matrix.seed }}_work/*.sscore
          if-no-files-found: error

      - name: Retry upload scores
        if: steps.upload-scores-primary.outcome != 'success'
        uses: actions/upload-artifact@v4
        with:
          name: model-scores-${{ matrix.sim_name }}-s${{ matrix.seed }}-${{ matrix.method }}
          path: ${{ matrix.sim_name }}_s${{ matrix.seed }}_work/*.sscore
          if-no-files-found: error

      - name: Save tool cache
        if: ${{ always() && steps.tools-cache.outputs.cache-hit != 'true' }}
        uses: actions/cache/save@v4
        with:
          path: |
            ~/.cache/uv
            ~/.cache/pip
            /usr/local/bin/plink2
            /usr/local/bin/gctb
          key: tools-${{ runner.os }}-${{ env.TOOL_CACHE_VERSION }}

  # ------------------------------------------------------------------
  # JOB 3: EVALUATE & CALIBRATE
  # ------------------------------------------------------------------
  evaluate:
    needs: [tool_cache, simulate, train]
    if: ${{ always() && needs.simulate.result == 'success' }}
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        sim_name: ${{ fromJSON(github.event_name == 'workflow_dispatch' && github.event.inputs.portability_only == 'true' && '["portability"]' || '["confounding","portability"]') }}
        seed: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15]
        exclude:
          - sim_name: confounding
            seed: 6
          - sim_name: confounding
            seed: 7
          - sim_name: confounding
            seed: 8
          - sim_name: confounding
            seed: 9
          - sim_name: confounding
            seed: 10
          - sim_name: confounding
            seed: 11
          - sim_name: confounding
            seed: 12
          - sim_name: confounding
            seed: 13
          - sim_name: confounding
            seed: 14
          - sim_name: confounding
            seed: 15
    steps:
      - uses: actions/checkout@v4

      - name: Restore tool cache
        id: tools-cache
        uses: actions/cache/restore@v4
        with:
          path: |
            ~/.cache/uv
            ~/.cache/pip
            /usr/local/bin/plink2
            /usr/local/bin/gctb
          key: tools-${{ runner.os }}-${{ env.TOOL_CACHE_VERSION }}

      - name: Install R for GAM (apt)
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends r-base

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: 'pip'

      - name: Install Python Dependencies
        run: |
          pip install uv
          uv pip install --system -r sims/requirements.txt
          uv pip install --system rpy2
          uv pip install --system pgscatalog-calc

      - name: Install R GAM package
        run: |
          set -euo pipefail
          for i in 1 2 3; do
            Rscript -e 'install.packages("mgcv", repos="https://cloud.r-project.org")' && break
            echo "mgcv install attempt $i failed; retrying..."
            sleep $((i*10))
          done

      - name: Download Simulation Data
        uses: actions/download-artifact@v4
        with:
          name: sim-data-${{ matrix.sim_name }}-s${{ matrix.seed }}
          path: .

      - name: Download BayesR Scores
        if: ${{ contains(fromJSON(env.TRAIN_METHODS), 'BayesR') }}
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: model-scores-${{ matrix.sim_name }}-s${{ matrix.seed }}-BayesR
          path: ${{ matrix.sim_name }}_s${{ matrix.seed }}_work/
          merge-multiple: true

      - name: Restore evaluation cache
        id: eval-cache
        uses: actions/cache/restore@v4
        with:
          path: |
            ${{ matrix.sim_name }}_s${{ matrix.seed }}_metrics.csv
            ${{ matrix.sim_name }}_s${{ matrix.seed }}_comparison_*.png
            ${{ matrix.sim_name }}_s${{ matrix.seed }}_significance_tests.csv
          key: eval-${{ runner.os }}-${{ matrix.sim_name }}-s${{ matrix.seed }}-${{ hashFiles('sims/evaluate.py', 'sims/metrics.py', 'sims/methods/**') }}
          restore-keys: |
            eval-${{ runner.os }}-${{ matrix.sim_name }}-s${{ matrix.seed }}-



      - name: Install gnomon (binary release)
        if: ${{ env.ENABLE_GNOMON == 'true' }}
        run: |
          bash install.sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Calibration Analysis
        if: steps.eval-cache.outputs.cache-hit != 'true'
        run: |
          set -e
          echo "Running Evaluation for Sim ${{ matrix.sim_name }} (seed=${{ matrix.seed }})..."
          if [ "${{ env.ENABLE_GNOMON }}" = "true" ]; then
            python sims/evaluate.py ${{ matrix.sim_name }}_s${{ matrix.seed }} --enable-gnomon
          else
            python sims/evaluate.py ${{ matrix.sim_name }}_s${{ matrix.seed }}
          fi

      - name: Save evaluation cache
        if: ${{ always() && steps.eval-cache.outputs.cache-hit != 'true' }}
        uses: actions/cache/save@v4
        with:
          path: |
            ${{ matrix.sim_name }}_s${{ matrix.seed }}_metrics.csv
            ${{ matrix.sim_name }}_s${{ matrix.seed }}_comparison_*.png
            ${{ matrix.sim_name }}_s${{ matrix.seed }}_significance_tests.csv
          key: eval-${{ runner.os }}-${{ matrix.sim_name }}-s${{ matrix.seed }}-${{ hashFiles('sims/evaluate.py', 'sims/metrics.py', 'sims/methods/**') }}

      - name: Upload Results (Stream B)
        id: upload-results-primary
        continue-on-error: true
        uses: actions/upload-artifact@v4
        with:
          name: sim-results-${{ matrix.sim_name }}-s${{ matrix.seed }}
          path: |
            ${{ matrix.sim_name }}_s${{ matrix.seed }}_metrics.csv
            ${{ matrix.sim_name }}_s${{ matrix.seed }}_comparison_*.png
            ${{ matrix.sim_name }}_s${{ matrix.seed }}_significance_tests.csv
            ${{ matrix.sim_name }}_s${{ matrix.seed }}_probabilities.csv
            ${{ matrix.sim_name }}_s${{ matrix.seed }}_probability_summary.csv
          if-no-files-found: warn

      - name: Retry upload results
        if: steps.upload-results-primary.outcome != 'success'
        uses: actions/upload-artifact@v4
        with:
          name: sim-results-${{ matrix.sim_name }}-s${{ matrix.seed }}
          path: |
            ${{ matrix.sim_name }}_s${{ matrix.seed }}_metrics.csv
            ${{ matrix.sim_name }}_s${{ matrix.seed }}_comparison_*.png
            ${{ matrix.sim_name }}_s${{ matrix.seed }}_significance_tests.csv
            ${{ matrix.sim_name }}_s${{ matrix.seed }}_probabilities.csv
            ${{ matrix.sim_name }}_s${{ matrix.seed }}_probability_summary.csv
          if-no-files-found: warn

      - name: Save tool cache
        if: ${{ always() && steps.tools-cache.outputs.cache-hit != 'true' }}
        uses: actions/cache/save@v4
        with:
          path: |
            ~/.cache/uv
            ~/.cache/pip
            /usr/local/bin/plink2
            /usr/local/bin/gctb
          key: tools-${{ runner.os }}-${{ env.TOOL_CACHE_VERSION }}

  # ------------------------------------------------------------------
  # JOB 4: REPORT (Consolidate)
  # ------------------------------------------------------------------
  report:
    runs-on: ubuntu-22.04
    needs: [tool_cache, evaluate]
    if: always()
    steps:
      - uses: actions/checkout@v4
      
      - name: Restore tool cache
        id: tools-cache
        uses: actions/cache/restore@v4
        with:
          path: |
            ~/.cache/uv
            ~/.cache/pip
            /usr/local/bin/plink2
            /usr/local/bin/gctb
          key: tools-${{ runner.os }}-${{ env.TOOL_CACHE_VERSION }}
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      
      - name: Install dependencies
        run: |
          pip install uv
          uv pip install --system -r sims/requirements.txt
          uv pip install --system pandas tabulate
          uv pip install --system pgscatalog-calc

      - name: Install gnomon (binary release)
        if: ${{ env.ENABLE_GNOMON == 'true' }}
        run: |
          bash install.sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Download all results
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          pattern: sim-results-*
          path: .
          merge-multiple: true

      - name: List downloaded files
        run: |
          echo "Files in current directory:"
          ls -la
          echo "CSV files:"
          ls -la *.csv 2>/dev/null || echo "No CSV files found"
          echo "PNG files:"
          ls -la *.png 2>/dev/null || echo "No PNG files found"
      
      - name: Aggregate metrics & p-values
        run: |
          python sims/aggregate_results.py
      
      - name: Generate consolidated summary
        run: |
          # Ensure generate_summary.py is robust to missing files if some jobs failed
          python sims/generate_summary.py

      - name: Build combined results zip
        run: |
          set -euo pipefail
          mkdir -p bundle
          for f in \
            summary.md \
            all_methods_metrics.tsv \
            all_methods_pvalues.png \
            confounding_metrics.csv \
            portability_metrics.csv \
            confounding_significance_tests.csv \
            portability_significance_tests.csv \
            confounding_probabilities.csv \
            portability_probabilities.csv \
            confounding_probability_summary.csv \
            portability_probability_summary.csv \
            confounding_comparison_roc.png \
            confounding_comparison_calibration.png \
            confounding_comparison_auc.png \
            confounding_comparison_brier.png \
            portability_comparison_roc.png \
            portability_comparison_calibration.png \
            portability_comparison_auc.png \
            portability_comparison_brier.png \
            portability_eur_minus_non_eur_gap_proper_test_all_pvals.png \
            portability_eur_minus_non_eur_proper_per_seed.csv \
            portability_eur_minus_non_eur_proper_summary.csv \
            portability_test_group_counts.csv \
            portability_auc_by_ancestry_95ci.png \
            portability_auc_by_ancestry_95ci_hierarchical.png \
            portability_auc_by_ancestry_95ci_hierarchical.csv \
            portability_auc_by_ancestry_hierarchical_per_seed.csv
          do
            if [ -f "$f" ]; then
              cp "$f" bundle/
            fi
          done
          (cd bundle && zip -r ../stdpopsim-chr22-results.zip .)

      - name: Upload summary as artifact
        id: upload-summary-primary
        continue-on-error: true
        uses: actions/upload-artifact@v4
        with:
          name: stdpopsim-chr22-results
          path: |
            stdpopsim-chr22-results.zip

      - name: Retry upload summary artifact
        if: steps.upload-summary-primary.outcome != 'success'
        uses: actions/upload-artifact@v4
        with:
          name: stdpopsim-chr22-results
          path: |
            stdpopsim-chr22-results.zip

      - name: Save tool cache
        if: ${{ always() && steps.tools-cache.outputs.cache-hit != 'true' }}
        uses: actions/cache/save@v4
        with:
          path: |
            ~/.cache/uv
            ~/.cache/pip
            /usr/local/bin/plink2
            /usr/local/bin/gctb
          key: tools-${{ runner.os }}-${{ env.TOOL_CACHE_VERSION }}

  # ------------------------------------------------------------------
  # JOB 5: TWO-POP SIMS (divergence, bottleneck)
  # ------------------------------------------------------------------
  two_pop_simulate_train_eval:
    needs: tool_cache
    if: ${{ github.event_name != 'workflow_dispatch' || github.event.inputs.portability_only != 'true' }}
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        sim_name: [divergence, bottleneck]
        divergence_gens: [0, 20, 50, 100, 500, 1000, 5000, 10000]
        seed: [1, 2, 3, 4, 5]
    steps:
      - uses: actions/checkout@v4

      - name: Reclaim disk space
        run: |
          set -euo pipefail
          echo "Disk before cleanup:"
          df -h
          sudo rm -rf /usr/share/dotnet || true
          sudo rm -rf /opt/ghc || true
          sudo rm -rf /usr/local/lib/android || true
          sudo rm -rf /opt/hostedtoolcache/CodeQL || true
          sudo apt-get clean || true
          echo "Disk after cleanup:"
          df -h

      - name: Restore tool cache
        id: tools-cache
        uses: actions/cache/restore@v4
        with:
          path: |
            ~/.cache/uv
            ~/.cache/pip
            /usr/local/bin/plink2
            /usr/local/bin/gctb
          key: tools-${{ runner.os }}-${{ env.TOOL_CACHE_VERSION }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install R for GAM (apt)
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends r-base

      - name: Install Python Dependencies
        run: |
          pip install uv
          uv pip install --system -r sims/requirements.txt
          uv pip install --system rpy2

      - name: Install R GAM package
        run: |
          set -euo pipefail
          for i in 1 2 3; do
            Rscript -e 'install.packages("mgcv", repos="https://cloud.r-project.org")' && break
            echo "mgcv install attempt $i failed; retrying..."
            sleep $((i*10))
          done

      - name: Install Plink2
        run: |
          wget https://s3.amazonaws.com/plink2-assets/plink2_linux_avx2_20260110.zip -O plink2.zip
          unzip plink2.zip
          sudo mv plink2 /usr/local/bin/
          rm plink2.zip

      - name: Install GCTB (BayesR)
        run: |
          mkdir -p gctb_bin
          wget https://cnsgenomics.com/software/gctb/download/gctb_2.03beta_Linux.zip
          unzip gctb_2.03beta_Linux.zip -d gctb_bin
          sudo mv gctb_bin/gctb_2.03beta_Linux/gctb /usr/local/bin/
          chmod +x /usr/local/bin/gctb

      - name: Install gnomon (binary release)
        if: ${{ env.ENABLE_GNOMON == 'true' }}
        run: |
          bash install.sh

      - name: Restore two-pop cache
        id: two-pop-cache
        uses: actions/cache/restore@v4
        with:
          path: |
            ${{ matrix.sim_name }}_g${{ matrix.divergence_gens }}_s${{ matrix.seed }}.tsv
            ${{ matrix.sim_name }}_g${{ matrix.divergence_gens }}_s${{ matrix.seed }}.bed
            ${{ matrix.sim_name }}_g${{ matrix.divergence_gens }}_s${{ matrix.seed }}.bim
            ${{ matrix.sim_name }}_g${{ matrix.divergence_gens }}_s${{ matrix.seed }}.fam
            ${{ matrix.sim_name }}_g${{ matrix.divergence_gens }}_s${{ matrix.seed }}_sites.npz
            ${{ matrix.sim_name }}_g${{ matrix.divergence_gens }}_s${{ matrix.seed }}_work/
            ${{ matrix.sim_name }}_g${{ matrix.divergence_gens }}_s${{ matrix.seed }}_metrics.csv
            ${{ matrix.sim_name }}_g${{ matrix.divergence_gens }}_s${{ matrix.seed }}_comparison_*.png
            ${{ matrix.sim_name }}_g${{ matrix.divergence_gens }}_s${{ matrix.seed }}_pcs.png
          key: two-pop-${{ runner.os }}-${{ matrix.sim_name }}-g${{ matrix.divergence_gens }}-s${{ matrix.seed }}-${{ hashFiles('sims/sim_two_pop.py', 'sims/split_data.py', 'sims/train_model.py', 'sims/evaluate.py', 'sims/methods/**', 'sims/metrics.py') }}
          restore-keys: |
            two-pop-${{ runner.os }}-${{ matrix.sim_name }}-g${{ matrix.divergence_gens }}-s${{ matrix.seed }}-

      - name: Run simulation
        if: steps.two-pop-cache.outputs.cache-hit != 'true'
        run: |
          python sims/sim_two_pop.py ${{ matrix.sim_name }} ${{ matrix.divergence_gens }} ${{ matrix.seed }}

      - name: Split data
        if: steps.two-pop-cache.outputs.cache-hit != 'true'
        run: |
          python sims/split_data.py ${{ matrix.sim_name }}_g${{ matrix.divergence_gens }}_s${{ matrix.seed }}

      - name: Train BayesR
        if: steps.two-pop-cache.outputs.cache-hit != 'true'
        run: |
          python sims/train_model.py ${{ matrix.sim_name }}_g${{ matrix.divergence_gens }}_s${{ matrix.seed }} BayesR

      - name: Evaluate calibration methods
        if: steps.two-pop-cache.outputs.cache-hit != 'true'
        run: |
          if [ "${{ env.ENABLE_GNOMON }}" = "true" ]; then
            python sims/evaluate.py ${{ matrix.sim_name }}_g${{ matrix.divergence_gens }}_s${{ matrix.seed }} --enable-gnomon
          else
            python sims/evaluate.py ${{ matrix.sim_name }}_g${{ matrix.divergence_gens }}_s${{ matrix.seed }}
          fi

      - name: Save two-pop cache
        if: ${{ always() && steps.two-pop-cache.outputs.cache-hit != 'true' }}
        uses: actions/cache/save@v4
        with:
          path: |
            ${{ matrix.sim_name }}_g${{ matrix.divergence_gens }}_s${{ matrix.seed }}.tsv
            ${{ matrix.sim_name }}_g${{ matrix.divergence_gens }}_s${{ matrix.seed }}.bed
            ${{ matrix.sim_name }}_g${{ matrix.divergence_gens }}_s${{ matrix.seed }}.bim
            ${{ matrix.sim_name }}_g${{ matrix.divergence_gens }}_s${{ matrix.seed }}.fam
            ${{ matrix.sim_name }}_g${{ matrix.divergence_gens }}_s${{ matrix.seed }}_sites.npz
            ${{ matrix.sim_name }}_g${{ matrix.divergence_gens }}_s${{ matrix.seed }}_work/
            ${{ matrix.sim_name }}_g${{ matrix.divergence_gens }}_s${{ matrix.seed }}_metrics.csv
            ${{ matrix.sim_name }}_g${{ matrix.divergence_gens }}_s${{ matrix.seed }}_comparison_*.png
            ${{ matrix.sim_name }}_g${{ matrix.divergence_gens }}_s${{ matrix.seed }}_pcs.png
          key: two-pop-${{ runner.os }}-${{ matrix.sim_name }}-g${{ matrix.divergence_gens }}-s${{ matrix.seed }}-${{ hashFiles('sims/sim_two_pop.py', 'sims/split_data.py', 'sims/train_model.py', 'sims/evaluate.py', 'sims/methods/**', 'sims/metrics.py') }}

      - name: Upload artifacts
        id: upload-two-pop-primary
        continue-on-error: true
        uses: actions/upload-artifact@v4
        with:
          name: two-pop-${{ matrix.sim_name }}-g${{ matrix.divergence_gens }}-s${{ matrix.seed }}
          path: |
            ${{ matrix.sim_name }}_g${{ matrix.divergence_gens }}_s${{ matrix.seed }}_metrics.csv
            ${{ matrix.sim_name }}_g${{ matrix.divergence_gens }}_s${{ matrix.seed }}_comparison_roc.png
            ${{ matrix.sim_name }}_g${{ matrix.divergence_gens }}_s${{ matrix.seed }}_comparison_calibration.png
            ${{ matrix.sim_name }}_g${{ matrix.divergence_gens }}_s${{ matrix.seed }}_comparison_auc.png
            ${{ matrix.sim_name }}_g${{ matrix.divergence_gens }}_s${{ matrix.seed }}_pcs.png
          if-no-files-found: error

      - name: Retry upload two-pop artifacts
        if: steps.upload-two-pop-primary.outcome != 'success'
        uses: actions/upload-artifact@v4
        with:
          name: two-pop-${{ matrix.sim_name }}-g${{ matrix.divergence_gens }}-s${{ matrix.seed }}
          path: |
            ${{ matrix.sim_name }}_g${{ matrix.divergence_gens }}_s${{ matrix.seed }}_metrics.csv
            ${{ matrix.sim_name }}_g${{ matrix.divergence_gens }}_s${{ matrix.seed }}_comparison_roc.png
            ${{ matrix.sim_name }}_g${{ matrix.divergence_gens }}_s${{ matrix.seed }}_comparison_calibration.png
            ${{ matrix.sim_name }}_g${{ matrix.divergence_gens }}_s${{ matrix.seed }}_comparison_auc.png
            ${{ matrix.sim_name }}_g${{ matrix.divergence_gens }}_s${{ matrix.seed }}_pcs.png
          if-no-files-found: error

      - name: Save tool cache
        if: ${{ always() && steps.tools-cache.outputs.cache-hit != 'true' }}
        uses: actions/cache/save@v4
        with:
          path: |
            ~/.cache/uv
            ~/.cache/pip
            /usr/local/bin/plink2
            /usr/local/bin/gctb
          key: tools-${{ runner.os }}-${{ env.TOOL_CACHE_VERSION }}

  two_pop_plot_auc:
    needs: [tool_cache, two_pop_simulate_train_eval]
    if: ${{ github.event_name != 'workflow_dispatch' || github.event.inputs.portability_only != 'true' }}
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install Python Dependencies
        run: |
          pip install uv
          uv pip install --system pandas matplotlib

      - name: Download metrics artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: two-pop-*
          path: .
          merge-multiple: true

      - name: Build divergence/bottleneck AUC plot
        run: |
          python sims/plot_divergence_auc.py

      - name: Build two-pop PC mega plot
        run: |
          python sims/plot_two_pop_pcs_grid.py

      - name: Upload AUC plot
        id: upload-auc-plot-primary
        continue-on-error: true
        uses: actions/upload-artifact@v4
        with:
          name: two-pop-auc-plot
          path: |
            divergence_bottleneck_auc.csv
            divergence_bottleneck_auc.png
            divergence_bottleneck_auc_*.png
            two_pop_pcs_mega.png
          if-no-files-found: error

      - name: Retry upload AUC plot
        if: steps.upload-auc-plot-primary.outcome != 'success'
        uses: actions/upload-artifact@v4
        with:
          name: two-pop-auc-plot
          path: |
            divergence_bottleneck_auc.csv
            divergence_bottleneck_auc.png
            divergence_bottleneck_auc_*.png
            two_pop_pcs_mega.png
          if-no-files-found: error
