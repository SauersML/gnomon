name: Jules Optimizer Loop

on:
  # Run every 30 minutes
  schedule:
    - cron: '*/30 * * * *'
  
  # Manual trigger
  workflow_dispatch:

permissions:
  contents: write
  actions: write

jobs:
  optimize:
    runs-on: ubuntu-latest
    # Increase timeout since Jules can take a while
    timeout-minutes: 120
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch all history for git operations
          
      # --- Lean Setup Steps (Copied from Prover CI) ---

      - name: Install elan
        run: |
          curl https://raw.githubusercontent.com/leanprover/elan/master/elan-init.sh -sSf | sh -s -- -y
          echo "$HOME/.elan/bin" >> $GITHUB_PATH

      - name: Cache Lean toolchain
        uses: actions/cache@v4
        with:
          path: ~/.elan
          key: ${{ runner.os }}-elan-${{ hashFiles('lean-toolchain') }}

      - name: Cache everything Lake-related
        id: cache-lake-all
        uses: actions/cache@v4
        with:
          path: |
            .lake
          key: ${{ runner.os }}-lake-v5-${{ hashFiles('lean-toolchain', 'lake-manifest.json') }}
          restore-keys: |
            ${{ runner.os }}-lake-v5-${{ hashFiles('lean-toolchain') }}-

      - name: Enforce manifest integrity
        run: |
          # Failsafe: Ensure the cache never overwrites our locked dependencies.
          git restore lake-manifest.json

      - name: Verify cache completeness
        id: check-cache
        run: |
          echo "ðŸ” Checking cache completeness..."
          if [ ! -d ".lake" ]; then
            echo "valid=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          EXPECTED_PACKAGES=("mathlib" "aesop" "batteries" "proofwidgets" "Qq" "plausible" "LeanSearchClient" "importGraph" "Cli")
          ALL_FOUND=true
          for pkg in "${EXPECTED_PACKAGES[@]}"; do
            if [ ! -d ".lake/packages/$pkg" ]; then ALL_FOUND=false; fi
          done

          if [ "$ALL_FOUND" = true ]; then echo "valid=true" >> $GITHUB_OUTPUT; else echo "valid=false" >> $GITHUB_OUTPUT; fi

      - name: Update and fetch dependencies (only if cache miss)
        if: steps.check-cache.outputs.valid != 'true'
        run: |
          # Do NOT run lake update - use the lockfile!
          echo "ðŸ“¥ Downloading mathlib cache..."
          lake exe cache get

      - name: Build all dependencies (only if cache miss)
        if: steps.check-cache.outputs.valid != 'true'
        run: |
          lake build

      # --- Verification Step with Log Capture ---

      - name: Verify Proofs (Capture Output)
        id: verify
        run: |
          echo "ðŸš€ Building Calibrator..."
          set +e # Don't exit on failure

          # Run build and tee to log file
          lake build -v Calibrator > build.log 2>&1
          EXIT_CODE=$?

          echo "Build finished with exit code $EXIT_CODE"

          if [ $EXIT_CODE -eq 0 ]; then
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
          fi

          # Print the last few lines for immediate visibility in GHA logs
          echo "--- Tail of build.log ---"
          tail -n 20 build.log

      # --- Jules Optimization Step ---

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install requests

      - name: Run Jules Loop Script
        env:
          JULES_API_KEY: ${{ secrets.JULES_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          LOCAL_LOG_FILE: build.log
          LOCAL_BUILD_STATUS: ${{ steps.verify.outputs.status }}
        run: python scripts/jules_loop.py
