name: Jules PR Validator

on:
  pull_request:
    types: [opened, synchronize, labeled]

permissions:
  contents: write
  pull-requests: write
  checks: read

jobs:
  validate-jules-pr:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Check if PR is from Jules Loop
        id: check-jules
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const labels = context.payload.pull_request.labels.map(l => l.name);
            const hasJulesLabel = labels.includes('jules-loop');
            const branchName = context.payload.pull_request.head.ref;
            
            // Jules API creates branches like: fix-calibrator-build-errors-1706132021149205343
            // Our script creates branches like: jules-improvement-20260205-120000
            const julesApiBranchPattern = /^fix-(calibrator|proofs|build).*-\d+$/;
            const julesScriptBranchPattern = /^jules-improvement-\d{8}-\d{6}$/;
            const hasJulesBranch = julesApiBranchPattern.test(branchName) || julesScriptBranchPattern.test(branchName);
            
            const isJulesPR = hasJulesLabel || hasJulesBranch;

            console.log('PR Labels:', labels);
            console.log('Branch Name:', branchName);
            console.log('Has Jules Label:', hasJulesLabel);
            console.log('Has Jules Branch Pattern:', hasJulesBranch);
            console.log('Is Jules PR:', isJulesPR);

            if (isJulesPR) {
              console.log('‚úì This is a Jules Loop PR - will validate');
              core.setOutput('is_jules_pr', 'true');
            } else {
              console.log('‚Üí Not a Jules Loop PR - skipping validation');
              core.setOutput('is_jules_pr', 'false');
            }

      - name: Checkout PR
        if: steps.check-jules.outputs.is_jules_pr == 'true'
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: Fetch base branch
        if: steps.check-jules.outputs.is_jules_pr == 'true'
        run: |
          git fetch origin ${{ github.event.pull_request.base.ref }}

      - name: Validate file changes
        if: steps.check-jules.outputs.is_jules_pr == 'true'
        id: validate-files
        run: |
          echo "üîç Checking file changes..."

          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"

          # Get list of changed files with their status
          CHANGED_FILES=$(git diff --name-status $BASE_SHA...$HEAD_SHA)

          echo "Changed files:"
          echo "$CHANGED_FILES"
          echo ""

          VALIDATION_FAILED=false
          FAILURE_REASON=""

          # Check for created files (A = Added)
          CREATED_FILES=$(echo "$CHANGED_FILES" | grep "^A" || true)
          if [ -n "$CREATED_FILES" ]; then
            echo "‚ùå FAIL: PR creates new files"
            echo "$CREATED_FILES"
            VALIDATION_FAILED=true
            FAILURE_REASON="PR creates new files:\n\`\`\`\n$CREATED_FILES\n\`\`\`"
          fi

          # Check for deleted files (D = Deleted)
          DELETED_FILES=$(echo "$CHANGED_FILES" | grep "^D" || true)
          if [ -n "$DELETED_FILES" ]; then
            echo "‚ùå FAIL: PR deletes files"
            echo "$DELETED_FILES"
            VALIDATION_FAILED=true
            if [ -n "$FAILURE_REASON" ]; then
              FAILURE_REASON="$FAILURE_REASON\n\n"
            fi
            FAILURE_REASON="${FAILURE_REASON}PR deletes files:\n\`\`\`\n$DELETED_FILES\n\`\`\`"
          fi

          # Check for modifications outside proofs/ directory
          MODIFIED_FILES=$(echo "$CHANGED_FILES" | grep "^M" | awk '{print $2}' || true)
          OUTSIDE_PROOFS=""

          while IFS= read -r file; do
            if [ -n "$file" ] && [[ ! "$file" =~ ^proofs/ ]]; then
              OUTSIDE_PROOFS="$OUTSIDE_PROOFS$file\n"
            fi
          done <<< "$MODIFIED_FILES"

          if [ -n "$OUTSIDE_PROOFS" ]; then
            echo "‚ùå FAIL: PR modifies files outside proofs/ directory"
            echo -e "$OUTSIDE_PROOFS"
            VALIDATION_FAILED=true
            if [ -n "$FAILURE_REASON" ]; then
              FAILURE_REASON="$FAILURE_REASON\n\n"
            fi
            FAILURE_REASON="${FAILURE_REASON}PR modifies files outside \`proofs/\` directory:\n\`\`\`\n$(echo -e "$OUTSIDE_PROOFS")\`\`\`"
          fi

          if [ "$VALIDATION_FAILED" = true ]; then
            echo "validation_passed=false" >> $GITHUB_OUTPUT
            # Escape newlines for GitHub output
            echo "failure_reason<<EOF" >> $GITHUB_OUTPUT
            echo -e "$FAILURE_REASON" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "‚úÖ File validation passed"
            echo "validation_passed=true" >> $GITHUB_OUTPUT
          fi

          # Calculate line additions and deletions for auto-merge decision
          STATS=$(git diff --stat $BASE_SHA...$HEAD_SHA | tail -1)
          echo "Stats: $STATS"
          
          # Extract insertions and deletions from stats line like "1 file changed, 10 insertions(+), 3 deletions(-)"
          ADDITIONS=$(echo "$STATS" | grep -oE '[0-9]+ insertion' | grep -oE '[0-9]+' || echo "0")
          DELETIONS=$(echo "$STATS" | grep -oE '[0-9]+ deletion' | grep -oE '[0-9]+' || echo "0")
          
          # Handle empty values
          ADDITIONS=${ADDITIONS:-0}
          DELETIONS=${DELETIONS:-0}
          
          echo "Additions: $ADDITIONS, Deletions: $DELETIONS"
          echo "additions=$ADDITIONS" >> $GITHUB_OUTPUT
          echo "deletions=$DELETIONS" >> $GITHUB_OUTPUT
          
          # Check if no new files were created
          if [ -z "$CREATED_FILES" ]; then
            echo "no_new_files=true" >> $GITHUB_OUTPUT
          else
            echo "no_new_files=false" >> $GITHUB_OUTPUT
          fi

      - name: Close PR if file validation failed
        if: steps.check-jules.outputs.is_jules_pr == 'true' && steps.validate-files.outputs.validation_passed == 'false'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // Use JSON.stringify to safely encode the string from bash output to JS
            // The output from the previous step might contain backticks, newlines, etc.
            const failureReasonRaw = `${{ steps.validate-files.outputs.failure_reason }}`;

            // Just use the raw string since it comes from GitHub Actions context interpolation
            // which happens before JS execution. However, if the bash step output contained
            // unescaped characters that break JS string literal syntax when interpolated,
            // we need to be careful. The bash step already tried to format it.

            // Let's try to make it safer by not assuming it's a valid template literal content if it has backticks
            const failureReason = failureReasonRaw;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## ‚ùå Jules Loop PR Validation Failed\n\n**Reason:** File change violations detected.\n\n${failureReason}\n\n**Jules Loop Rules:**\n- ‚úó Cannot create new files\n- ‚úó Cannot delete files\n- ‚úó Can only modify files in \`proofs/\` directory\n\nThis PR has been automatically closed.`
            });

            await github.rest.pulls.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              state: 'closed'
            });

            core.setFailed('PR validation failed: ' + failureReason);

      # Only run Lean build if file validation passed
      - name: Install elan
        if: steps.check-jules.outputs.is_jules_pr == 'true' && steps.validate-files.outputs.validation_passed == 'true'
        run: |
          curl https://raw.githubusercontent.com/leanprover/elan/master/elan-init.sh -sSf | sh -s -- -y
          echo "$HOME/.elan/bin" >> $GITHUB_PATH

      - name: Cache Lean toolchain
        if: steps.check-jules.outputs.is_jules_pr == 'true' && steps.validate-files.outputs.validation_passed == 'true'
        uses: actions/cache@v4
        with:
          path: ~/.elan
          key: ${{ runner.os }}-elan-${{ hashFiles('lean-toolchain') }}

      - name: Cache Lake dependencies
        if: steps.check-jules.outputs.is_jules_pr == 'true' && steps.validate-files.outputs.validation_passed == 'true'
        uses: actions/cache@v4
        with:
          path: .lake
          key: ${{ runner.os }}-lake-v5-${{ hashFiles('lean-toolchain', 'lake-manifest.json') }}
          restore-keys: |
            ${{ runner.os }}-lake-v5-${{ hashFiles('lean-toolchain') }}-

      - name: Enforce manifest integrity
        if: steps.check-jules.outputs.is_jules_pr == 'true' && steps.validate-files.outputs.validation_passed == 'true'
        run: git restore lake-manifest.json

      - name: Fetch dependencies if needed
        if: steps.check-jules.outputs.is_jules_pr == 'true' && steps.validate-files.outputs.validation_passed == 'true'
        run: |
          if [ ! -d ".lake/packages/mathlib" ]; then
            echo "üì• Downloading mathlib cache..."
            lake exe cache get
            lake build
          fi

      - name: Build Lean proofs
        if: steps.check-jules.outputs.is_jules_pr == 'true' && steps.validate-files.outputs.validation_passed == 'true'
        id: lean-build
        run: |
          echo "üöÄ Building Calibrator..."
          set +e
          lake build Calibrator > build.log 2>&1
          EXIT_CODE=$?
          set -e

          echo "--- Build Log (last 50 lines) ---"
          tail -n 50 build.log

          if [ $EXIT_CODE -eq 0 ]; then
            echo "build_passed=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Lean build passed"
          else
            echo "build_passed=false" >> $GITHUB_OUTPUT
            echo "‚ùå Lean build failed"

            # Extract error messages
            ERROR_SUMMARY=$(tail -n 100 build.log | grep -E "error:|Error|FAILED" || echo "Build failed - see logs")
            echo "error_summary<<EOF" >> $GITHUB_OUTPUT
            echo "$ERROR_SUMMARY" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Close PR if Lean build failed
        if: steps.check-jules.outputs.is_jules_pr == 'true' && steps.validate-files.outputs.validation_passed == 'true' && steps.lean-build.outputs.build_passed == 'false'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const errorSummary = `${{ steps.lean-build.outputs.error_summary }}`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## ‚ùå Jules Loop PR Validation Failed\n\n**Reason:** Lean proof build failed.\n\n### Build Errors:\n\`\`\`\n${errorSummary}\n\`\`\`\n\n**Jules Loop Rules:**\n- ‚úì File changes valid (only modified files in \`proofs/\`)\n- ‚úó Lean build must pass\n\nThis PR has been automatically closed.`
            });

            await github.rest.pulls.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              state: 'closed'
            });

            core.setFailed('Lean build failed');

      - name: Check auto-merge eligibility and merge
        if: steps.check-jules.outputs.is_jules_pr == 'true' && steps.validate-files.outputs.validation_passed == 'true' && steps.lean-build.outputs.build_passed == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const additions = parseInt('${{ steps.validate-files.outputs.additions }}') || 0;
            const deletions = parseInt('${{ steps.validate-files.outputs.deletions }}') || 0;
            const noNewFiles = '${{ steps.validate-files.outputs.no_new_files }}' === 'true';
            
            // Auto-merge criteria:
            // 1. No new files created
            // 2. Additions > 3x deletions (minimal deletions)
            // 3. Build passed (already checked in the if condition)
            const minimalDeletions = deletions === 0 || additions > (deletions * 3);
            const canAutoMerge = noNewFiles && minimalDeletions;
            
            console.log(`Additions: ${additions}, Deletions: ${deletions}`);
            console.log(`No new files: ${noNewFiles}`);
            console.log(`Minimal deletions (additions > 3x deletions): ${minimalDeletions}`);
            console.log(`Can auto-merge: ${canAutoMerge}`);
            
            if (canAutoMerge) {
              // Comment before merging
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `## ‚úÖ Jules Loop PR Auto-Merged\n\n**All checks passed:**\n- ‚úì No files created or deleted\n- ‚úì Only modified files in \`proofs/\` directory\n- ‚úì Lean build passed\n- ‚úì Minimal deletions (${additions} additions, ${deletions} deletions)\n\nThis PR has been automatically merged.`
              });
              
              // Merge the PR
              await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.issue.number,
                merge_method: 'squash'
              });
              
              console.log('‚úÖ PR auto-merged successfully!');
            } else {
              // Just comment, don't merge
              let reason = [];
              if (!noNewFiles) reason.push('creates new files');
              if (!minimalDeletions) reason.push(`too many deletions (${deletions} deletions vs ${additions} additions, need additions > 3x deletions)`);
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `## ‚úÖ Jules Loop PR Validation Passed\n\n**All checks passed:**\n- ‚úì No files created or deleted\n- ‚úì Only modified files in \`proofs/\` directory\n- ‚úì Lean build passed\n\n**Not auto-merged because:** ${reason.join(', ')}\n\nThis PR is ready for manual review!`
              });
              
              console.log('PR passed validation but not auto-merged: ' + reason.join(', '));
            }
