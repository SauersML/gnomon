name: Sims (Gen0 + Bottleneck)

on:
  workflow_dispatch:
    inputs:
      profile:
        description: "Run profile"
        required: true
        default: "full"
        type: choice
        options:
          - quick
          - full
  schedule:
    - cron: "30 7 * * *"

env:
  PYTHONUNBUFFERED: "1"
  OMP_NUM_THREADS: "2"
  MKL_NUM_THREADS: "2"
  OPENBLAS_NUM_THREADS: "2"
  VECLIB_MAXIMUM_THREADS: "2"
  NUMEXPR_NUM_THREADS: "2"
  SIM_PROFILE: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.profile || 'quick' }}

jobs:
  gen0_chunks:
    name: "Gen0 chunk ${{ matrix.chunk.name }}"
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        chunk:
          - { name: "a", seed_start_quick: 1, seed_end_quick: 2, seed_start_full: 1, seed_end_full: 8 }
          - { name: "b", seed_start_quick: 3, seed_end_quick: 4, seed_start_full: 9, seed_end_full: 16 }
          - { name: "c", seed_start_quick: 5, seed_end_quick: 6, seed_start_full: 17, seed_end_full: 24 }
          - { name: "d", seed_start_quick: 7, seed_end_quick: 8, seed_start_full: 25, seed_end_full: 32 }
    steps:
      - uses: actions/checkout@v4

      - name: Define Gen0 simulation parameters
        id: gen0_params
        shell: bash
        run: |
          set -euo pipefail
          CPU_CORES="$(nproc)"
          if [ -z "$CPU_CORES" ] || [ "$CPU_CORES" -lt 1 ]; then
            CPU_CORES=1
          fi
          echo "workers=$CPU_CORES" >> "$GITHUB_OUTPUT"
          if [ "${SIM_PROFILE}" = "full" ]; then
            echo "seed_start=${{ matrix.chunk.seed_start_full }}" >> "$GITHUB_OUTPUT"
            echo "seed_end=${{ matrix.chunk.seed_end_full }}" >> "$GITHUB_OUTPUT"
            echo "n_ind=2200" >> "$GITHUB_OUTPUT"
            echo "seq_len=5000000" >> "$GITHUB_OUTPUT"
            echo "n_causal=5000" >> "$GITHUB_OUTPUT"
            echo "n_pca=2000" >> "$GITHUB_OUTPUT"
          else
            echo "seed_start=${{ matrix.chunk.seed_start_quick }}" >> "$GITHUB_OUTPUT"
            echo "seed_end=${{ matrix.chunk.seed_end_quick }}" >> "$GITHUB_OUTPUT"
            echo "n_ind=1000" >> "$GITHUB_OUTPUT"
            echo "seq_len=2000000" >> "$GITHUB_OUTPUT"
            echo "n_causal=1200" >> "$GITHUB_OUTPUT"
            echo "n_pca=700" >> "$GITHUB_OUTPUT"
          fi

      - name: Restore Gen0 simulation cache
        id: gen0_cache_restore
        uses: actions/cache/restore@v4
        with:
          path: sims/results_gen0/chunks/gen0_chunk_${{ matrix.chunk.name }}.csv
          key: gen0-sim-${{ runner.os }}-${{ env.SIM_PROFILE }}-${{ matrix.chunk.name }}-${{ steps.gen0_params.outputs.seed_start }}-${{ steps.gen0_params.outputs.seed_end }}-${{ steps.gen0_params.outputs.n_ind }}-${{ steps.gen0_params.outputs.seq_len }}-${{ steps.gen0_params.outputs.n_causal }}-${{ steps.gen0_params.outputs.n_pca }}-${{ hashFiles('sims/gen0_orthogonalization.py', 'sims/sim_two_pop.py', 'sims/split_data.py', 'sims/train_model.py', 'sims/requirements.txt') }}

      - name: Restore Gen0 BayesR intermediate cache
        if: steps.gen0_cache_restore.outputs.cache-hit != 'true'
        id: gen0_bayesr_cache_restore
        uses: actions/cache/restore@v4
        with:
          path: |
            divergence_g0_s*.tsv
            divergence_g0_s*.bed
            divergence_g0_s*.bim
            divergence_g0_s*.fam
            divergence_g0_s*_sites.npz
            divergence_g0_s*_pcs.png
            divergence_g0_s*_work/**
          key: gen0-bayesr-${{ runner.os }}-${{ matrix.chunk.name }}-${{ steps.gen0_params.outputs.seed_start }}-${{ steps.gen0_params.outputs.seed_end }}-plink2_20260110-gctb_2_03beta-${{ hashFiles('sims/sim_two_pop.py', 'sims/split_data.py', 'sims/train_model.py', 'sims/plink_utils.py', 'sims/requirements.txt') }}

      - name: Check Gen0 BayesR cache completeness
        if: steps.gen0_cache_restore.outputs.cache-hit != 'true'
        id: gen0_bayesr_ready
        shell: bash
        run: |
          set -euo pipefail
          SEED_START="${{ steps.gen0_params.outputs.seed_start }}"
          SEED_END="${{ steps.gen0_params.outputs.seed_end }}"
          READY=true
          for s in $(seq "$SEED_START" "$SEED_END"); do
            if [ ! -f "divergence_g0_s${s}.tsv" ] || [ ! -f "divergence_g0_s${s}_work/BayesR.sscore" ]; then
              READY=false
              break
            fi
          done
          echo "ready=$READY" >> "$GITHUB_OUTPUT"

      - name: Set up Python
        if: steps.gen0_cache_restore.outputs.cache-hit != 'true'
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        if: steps.gen0_cache_restore.outputs.cache-hit != 'true'
        run: |
          pip install uv
          uv pip install --system -r sims/requirements.txt

      - name: Install Plink2
        if: steps.gen0_cache_restore.outputs.cache-hit != 'true' && steps.gen0_bayesr_ready.outputs.ready != 'true'
        run: |
          set -euo pipefail
          wget -q https://s3.amazonaws.com/plink2-assets/plink2_linux_avx2_20260110.zip -O plink2.zip
          unzip -q plink2.zip
          sudo mv plink2 /usr/local/bin/
          rm -f plink2.zip

      - name: Install GCTB
        if: steps.gen0_cache_restore.outputs.cache-hit != 'true' && steps.gen0_bayesr_ready.outputs.ready != 'true'
        run: |
          set -euo pipefail
          wget -q https://cnsgenomics.com/software/gctb/download/gctb_2.03beta_Linux.zip -O gctb.zip
          unzip -q gctb.zip -d gctb_bin
          sudo mv gctb_bin/gctb_2.03beta_Linux/gctb /usr/local/bin/
          chmod +x /usr/local/bin/gctb
          rm -rf gctb.zip gctb_bin

      - name: Run Gen0 orthogonalization chunk
        if: steps.gen0_cache_restore.outputs.cache-hit != 'true'
        run: |
          set -euo pipefail

          SEED_START="${{ steps.gen0_params.outputs.seed_start }}"
          SEED_END="${{ steps.gen0_params.outputs.seed_end }}"
          N_IND="${{ steps.gen0_params.outputs.n_ind }}"
          SEQ_LEN="${{ steps.gen0_params.outputs.seq_len }}"
          N_CAUSAL="${{ steps.gen0_params.outputs.n_causal }}"
          N_PCA="${{ steps.gen0_params.outputs.n_pca }}"
          WORKERS="${{ steps.gen0_params.outputs.workers }}"
          BAYESR_MAX=$((SEED_END - SEED_START + 1))

          # Avoid nested thread oversubscription when using process workers.
          export OMP_NUM_THREADS=1
          export MKL_NUM_THREADS=1
          export OPENBLAS_NUM_THREADS=1
          export VECLIB_MAXIMUM_THREADS=1
          export NUMEXPR_NUM_THREADS=1

          OUT_DIR="sims/results_gen0/chunks"
          mkdir -p "$OUT_DIR"

          python sims/gen0_orthogonalization.py \
            --seed-start "$SEED_START" \
            --seed-end "$SEED_END" \
            --n-ind "$N_IND" \
            --seq-len "$SEQ_LEN" \
            --n-causal "$N_CAUSAL" \
            --n-pca-sites "$N_PCA" \
            --include-bayesr \
            --bayesr-max-seeds "$BAYESR_MAX" \
            --workers "$WORKERS" \
            --out-dir "$OUT_DIR/chunk_${{ matrix.chunk.name }}"

          cp "$OUT_DIR/chunk_${{ matrix.chunk.name }}/gen0_orthogonalization_results.csv" "$OUT_DIR/gen0_chunk_${{ matrix.chunk.name }}.csv"

      - name: Save Gen0 simulation cache
        if: steps.gen0_cache_restore.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: sims/results_gen0/chunks/gen0_chunk_${{ matrix.chunk.name }}.csv
          key: ${{ steps.gen0_cache_restore.outputs.cache-primary-key }}

      - name: Save Gen0 BayesR intermediate cache
        if: steps.gen0_cache_restore.outputs.cache-hit != 'true' && steps.gen0_bayesr_cache_restore.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: |
            divergence_g0_s*.tsv
            divergence_g0_s*.bed
            divergence_g0_s*.bim
            divergence_g0_s*.fam
            divergence_g0_s*_sites.npz
            divergence_g0_s*_pcs.png
            divergence_g0_s*_work/**
          key: ${{ steps.gen0_bayesr_cache_restore.outputs.cache-primary-key }}

      - name: Upload Gen0 chunk artifact
        uses: actions/upload-artifact@v4
        with:
          name: gen0-chunk-${{ matrix.chunk.name }}
          path: sims/results_gen0/chunks/gen0_chunk_${{ matrix.chunk.name }}.csv
          if-no-files-found: error
          retention-days: 7

  gen0_summarize:
    name: "Gen0 summarize"
    runs-on: ubuntu-22.04
    needs: gen0_chunks
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          pip install uv
          uv pip install --system -r sims/requirements.txt

      - name: Download chunk artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: gen0-chunk-*
          path: sims/results_gen0/chunks
          merge-multiple: true

      - name: Merge and summarize Gen0
        run: |
          set -euo pipefail

          python - <<'PY'
          from pathlib import Path
          import pandas as pd
          chunk_dir = Path("sims/results_gen0/chunks")
          files = sorted(chunk_dir.glob("gen0_chunk_*.csv"))
          if not files:
            raise SystemExit("No gen0 chunk files found")
          df = pd.concat([pd.read_csv(p) for p in files], ignore_index=True)
          merged = Path("sims/results_gen0/gen0_orthogonalization_merged.csv")
          merged.parent.mkdir(parents=True, exist_ok=True)
          df.to_csv(merged, index=False)
          print(f"Wrote {merged}")
          PY

          python sims/gen0_orthogonalization.py \
            --summary-only \
            --input-csv sims/results_gen0/gen0_orthogonalization_merged.csv \
            --out-dir sims/results_gen0

      - name: Upload Gen0 report artifacts
        uses: actions/upload-artifact@v4
        with:
          name: gen0-report
          path: |
            sims/results_gen0/gen0_orthogonalization_merged.csv
            sims/results_gen0/gen0_orthogonalization_summary.csv
            sims/results_gen0/gen0_pcg_coupling_summary.csv
            sims/results_gen0/gen0_hypothesis_tests.csv
            sims/results_gen0/fig_gen0_orthogonalization.png
          if-no-files-found: error
          retention-days: 14

  bottleneck_chunks:
    name: "Bottleneck chunk ${{ matrix.scenario }}-${{ matrix.gens.name }}"
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        scenario: [divergence, bottleneck]
        gens:
          - { name: "g0to200", quick: "0,20,50,100,200", full: "0,20,50,100,200" }
          - { name: "g500to1000", quick: "500,1000", full: "500,1000" }
          - { name: "g2000to5000", quick: "2000,5000", full: "2000,5000" }
    steps:
      - uses: actions/checkout@v4

      - name: Define bottleneck simulation parameters
        id: bottleneck_params
        shell: bash
        run: |
          set -euo pipefail
          CPU_CORES="$(nproc)"
          if [ -z "$CPU_CORES" ] || [ "$CPU_CORES" -lt 1 ]; then
            CPU_CORES=1
          fi
          echo "workers=$CPU_CORES" >> "$GITHUB_OUTPUT"
          if [ "${SIM_PROFILE}" = "full" ]; then
            echo "seeds=1,2,3,4,5,6,7,8,9,10" >> "$GITHUB_OUTPUT"
            echo "gens=${{ matrix.gens.full }}" >> "$GITHUB_OUTPUT"
            echo "seeds_key=1_2_3_4_5_6_7_8_9_10" >> "$GITHUB_OUTPUT"
            echo "gens_key=$(echo '${{ matrix.gens.full }}' | tr ',' '_')" >> "$GITHUB_OUTPUT"
            echo "n_per_pop=2000" >> "$GITHUB_OUTPUT"
            echo "seq_len=5000000" >> "$GITHUB_OUTPUT"
            echo "n_causal=400" >> "$GITHUB_OUTPUT"
            echo "min_tags=80" >> "$GITHUB_OUTPUT"
          else
            echo "seeds=1,2,3,4" >> "$GITHUB_OUTPUT"
            echo "gens=${{ matrix.gens.quick }}" >> "$GITHUB_OUTPUT"
            echo "seeds_key=1_2_3_4" >> "$GITHUB_OUTPUT"
            echo "gens_key=$(echo '${{ matrix.gens.quick }}' | tr ',' '_')" >> "$GITHUB_OUTPUT"
            echo "n_per_pop=900" >> "$GITHUB_OUTPUT"
            echo "seq_len=2500000" >> "$GITHUB_OUTPUT"
            echo "n_causal=220" >> "$GITHUB_OUTPUT"
            echo "min_tags=45" >> "$GITHUB_OUTPUT"
          fi

      - name: Restore bottleneck simulation cache
        id: bottleneck_cache_restore
        uses: actions/cache/restore@v4
        with:
          path: |
            sims/results_bottleneck_ld_mechanism/chunks/${{ matrix.scenario }}_${{ matrix.gens.name }}.csv
            sims/results_bottleneck_ld_mechanism/hetero_sweeps/${{ matrix.scenario }}_${{ matrix.gens.name }}_hetero_sweep.csv
          key: bottleneck-sim-${{ runner.os }}-${{ env.SIM_PROFILE }}-${{ matrix.scenario }}-${{ matrix.gens.name }}-${{ steps.bottleneck_params.outputs.seeds_key }}-${{ steps.bottleneck_params.outputs.gens_key }}-${{ steps.bottleneck_params.outputs.n_per_pop }}-${{ steps.bottleneck_params.outputs.seq_len }}-${{ steps.bottleneck_params.outputs.n_causal }}-${{ steps.bottleneck_params.outputs.min_tags }}-${{ hashFiles('sims/bottleneck_ld_mechanism.py', 'sims/sim_two_pop.py', 'sims/requirements.txt') }}

      - name: Set up Python
        if: steps.bottleneck_cache_restore.outputs.cache-hit != 'true'
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        if: steps.bottleneck_cache_restore.outputs.cache-hit != 'true'
        run: |
          pip install uv
          uv pip install --system -r sims/requirements.txt

      - name: Run bottleneck mechanism chunk
        if: steps.bottleneck_cache_restore.outputs.cache-hit != 'true'
        run: |
          set -euo pipefail

          SEEDS="${{ steps.bottleneck_params.outputs.seeds }}"
          GENS="${{ steps.bottleneck_params.outputs.gens }}"
          N_PER_POP="${{ steps.bottleneck_params.outputs.n_per_pop }}"
          SEQ_LEN="${{ steps.bottleneck_params.outputs.seq_len }}"
          N_CAUSAL="${{ steps.bottleneck_params.outputs.n_causal }}"
          MIN_TAGS="${{ steps.bottleneck_params.outputs.min_tags }}"
          WORKERS="${{ steps.bottleneck_params.outputs.workers }}"

          # Avoid nested thread oversubscription when using process workers.
          export OMP_NUM_THREADS=1
          export MKL_NUM_THREADS=1
          export OPENBLAS_NUM_THREADS=1
          export VECLIB_MAXIMUM_THREADS=1
          export NUMEXPR_NUM_THREADS=1

          CHUNK_DIR="sims/results_bottleneck_ld_mechanism/chunks"
          mkdir -p "$CHUNK_DIR"

          python sims/bottleneck_ld_mechanism.py run-chunk \
            --scenario "${{ matrix.scenario }}" \
            --gens "$GENS" \
            --seeds "$SEEDS" \
            --workers "$WORKERS" \
            --n-per-pop "$N_PER_POP" \
            --seq-len "$SEQ_LEN" \
            --n-causal "$N_CAUSAL" \
            --min-tags "$MIN_TAGS" \
            --out-dir "$CHUNK_DIR" \
            --chunk-name "${{ matrix.scenario }}_${{ matrix.gens.name }}"

      - name: Save bottleneck simulation cache
        if: steps.bottleneck_cache_restore.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: |
            sims/results_bottleneck_ld_mechanism/chunks/${{ matrix.scenario }}_${{ matrix.gens.name }}.csv
            sims/results_bottleneck_ld_mechanism/hetero_sweeps/${{ matrix.scenario }}_${{ matrix.gens.name }}_hetero_sweep.csv
          key: ${{ steps.bottleneck_cache_restore.outputs.cache-primary-key }}

      - name: Upload bottleneck chunk artifact
        uses: actions/upload-artifact@v4
        with:
          name: bottleneck-chunk-${{ matrix.scenario }}-${{ matrix.gens.name }}
          path: |
            sims/results_bottleneck_ld_mechanism/chunks/${{ matrix.scenario }}_${{ matrix.gens.name }}.csv
            sims/results_bottleneck_ld_mechanism/hetero_sweeps/${{ matrix.scenario }}_${{ matrix.gens.name }}_hetero_sweep.csv
          if-no-files-found: error
          retention-days: 7

  bottleneck_summarize:
    name: "Bottleneck summarize"
    runs-on: ubuntu-22.04
    needs: bottleneck_chunks
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          pip install uv
          uv pip install --system -r sims/requirements.txt

      - name: Download bottleneck chunk artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: bottleneck-chunk-*
          path: artifacts/bottleneck-chunks
          merge-multiple: true

      - name: Summarize bottleneck mechanism analysis
        run: |
          set -euo pipefail
          python sims/bottleneck_ld_mechanism.py summarize \
            --glob "artifacts/bottleneck-chunks/**/chunks/*.csv" \
            --sweep-glob "artifacts/bottleneck-chunks/**/hetero_sweeps/*_hetero_sweep.csv" \
            --out-dir sims/results_bottleneck_ld_mechanism

      - name: Upload bottleneck report artifacts
        uses: actions/upload-artifact@v4
        with:
          name: bottleneck-report
          path: |
            sims/results_bottleneck_ld_mechanism/bottleneck_ld_mechanism_results.csv
            sims/results_bottleneck_ld_mechanism/bottleneck_ld_mechanism_summary.csv
            sims/results_bottleneck_ld_mechanism/bottleneck_paired_deltas.csv
            sims/results_bottleneck_ld_mechanism/bottleneck_hypothesis_tests.csv
            sims/results_bottleneck_ld_mechanism/bottleneck_diagnostics.csv
            sims/results_bottleneck_ld_mechanism/bottleneck_heterozygosity_sweep_results.csv
            sims/results_bottleneck_ld_mechanism/fig1_near_vs_far.png
            sims/results_bottleneck_ld_mechanism/fig2_ld_vs_hetero_interventions.png
            sims/results_bottleneck_ld_mechanism/fig3_added_harm_correlates.png
            sims/results_bottleneck_ld_mechanism/fig4_heterozygosity_distributions.png
            sims/results_bottleneck_ld_mechanism/fig5_heterozygosity_manipulation_sweep.png
          if-no-files-found: error
          retention-days: 14

  ui_summary:
    name: "Workflow summary"
    runs-on: ubuntu-22.04
    needs: [gen0_summarize, bottleneck_summarize]
    steps:
      - name: Download Gen0 artifact
        uses: actions/download-artifact@v4
        with:
          name: gen0-report
          path: artifacts/gen0

      - name: Download bottleneck artifact
        uses: actions/download-artifact@v4
        with:
          name: bottleneck-report
          path: artifacts/bottleneck

      - name: Write GitHub UI summary
        run: |
          python - <<'PY'
          import csv
          from pathlib import Path

          out = Path("summary.md")
          gtests = Path("artifacts/gen0/gen0_hypothesis_tests.csv")
          btests = Path("artifacts/bottleneck/bottleneck_hypothesis_tests.csv")
          bdiag = Path("artifacts/bottleneck/bottleneck_diagnostics.csv")

          def read_csv(path):
              with open(path, newline="") as f:
                  return list(csv.DictReader(f))

          g = read_csv(gtests)
          b = read_csv(btests)
          d = read_csv(bdiag)

          dmap = {r["metric"]: r for r in d}

          lines = []
          lines.append("# Sims (Gen0 + Bottleneck) Summary")
          lines.append("")
          lines.append("## Gen0 hypothesis tests")
          lines.append("")
          lines.append("| Test | Contrast | Estimate | p-value |")
          lines.append("|---|---|---:|---:|")
          for r in g:
              lines.append(
                  f"| {r['test_id']} | `{r['contrast']}` | {float(r['estimate_mean']):.4f} | {float(r['p_value']):.4g} |"
              )

          lines.append("")
          lines.append("## Bottleneck hypothesis tests")
          lines.append("")
          lines.append("| Test | Contrast | Estimate | p-value |")
          lines.append("|---|---|---:|---:|")
          for r in b:
              lines.append(
                  f"| {r['test_id']} | `{r['contrast']}` | {float(r['estimate_mean']):.4f} | {float(r['p_value']):.4g} |"
              )

          lines.append("")
          lines.append("## Bottleneck diagnostics")
          lines.append("")
          lines.append("| Metric | Value | CI |")
          lines.append("|---|---:|---|")
          for key in [
              "corr_added_harm_vs_beta_decorrelation",
              "corr_added_harm_vs_heterozygosity_shift_delta",
              "null_r2_training_holdout_mean",
              "null_r2_target_population_mean",
          ]:
              r = dmap[key]
              clo = r["ci_lo"]
              chi = r["ci_hi"]
              ci = "-" if (clo == "" or chi == "") else f"[{float(clo):.3f}, {float(chi):.3f}]"
              lines.append(f"| `{key}` | {float(r['value']):.4f} | {ci} |")

          lines.append("")
          lines.append("Artifacts: `gen0-report`, `bottleneck-report`")
          out.write_text("\n".join(lines))
          print(out.read_text())
          PY
          cat summary.md >> "$GITHUB_STEP_SUMMARY"
