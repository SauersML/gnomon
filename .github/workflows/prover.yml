name: Lean Prover CI

on:
  push:
    branches: [ "main" ]
    paths:
      - 'proofs/**'
      - 'lakefile.lean'
      - 'lean-toolchain'
      - '.github/workflows/prover.yml'
  pull_request:
    branches: [ "main" ]
    paths:
      - 'proofs/**'
      - 'lakefile.lean'
      - 'lean-toolchain'
      - '.github/workflows/prover.yml'
  workflow_dispatch:

jobs:
  prove:
    runs-on: ubuntu-latest
    container:
      image: leanprovercommunity/mathlib:latest
      options: --user root
    timeout-minutes: 5
    
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        
      - name: Build and prove
        run: |
          # Fix permissions for the lean user
          chown -R 1000:1000 .
          
          # Run as the lean user
          su lean -c "lake build Calibrator --no-cache"
