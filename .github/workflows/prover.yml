name: Lean Prover CI

on:
  push:
    branches: [ "main" ]
    paths:
      - 'proofs/**'            # Any file inside the proofs directory
      - 'lakefile.lean'        # The Lean project configuration
      - 'lean-toolchain'       # The Lean version file
      - '.github/workflows/prover.yml' # The workflow file itself
  pull_request:
    branches: [ "main" ]
    paths:
      - 'proofs/**'
      - 'lakefile.lean'
      - 'lean-toolchain'
      - '.github/workflows/prover.yml'
  workflow_dispatch:

jobs:
  prove:
    runs-on: ubuntu-latest
    timeout-minutes: 60  # Prevent hanging builds
    
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        
      - name: Install elan
        run: |
          curl https://raw.githubusercontent.com/leanprover/elan/master/elan-init.sh -sSf | sh -s -- -y
          echo "$HOME/.elan/bin" >> $GITHUB_PATH
          
      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.elan
            ./lake-packages
          key: ${{ runner.os }}-lean-${{ hashFiles('lean-toolchain', 'lakefile.lean') }}
          restore-keys: |
            ${{ runner.os }}-lean-
            
      - name: Get mathlib cache
        run: |
          lake exe cache get || echo "Cache failed, building from source"
          
      - name: Build project
        run: |
          lake build
          
      - name: Check proofs
        run: |
          # Verify all files compile without errors
          lake build Calibrator
