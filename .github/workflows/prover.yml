name: Lean Prover CI

on:
  push:
    branches: [ "main" ]
    paths:
      - 'proofs/**'
      - 'lakefile.lean'
      - 'lean-toolchain'
      - '.github/workflows/prover.yml'
  pull_request:
    branches: [ "main" ]
    paths:
      - 'proofs/**'
      - 'lakefile.lean'
      - 'lean-toolchain'
      - '.github/workflows/prover.yml'
  workflow_dispatch:

jobs:
  prove:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        
      - name: Install elan
        run: |
          curl https://raw.githubusercontent.com/leanprover/elan/master/elan-init.sh -sSf | sh -s -- -y
          echo "$HOME/.elan/bin" >> $GITHUB_PATH
          
      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.elan
            .lake
          key: ${{ runner.os }}-lean-${{ hashFiles('lean-toolchain', 'lakefile.lean', 'lake-manifest.json') }}
          restore-keys: |
            ${{ runner.os }}-lean-${{ hashFiles('lean-toolchain', 'lakefile.lean') }}
            ${{ runner.os }}-lean-
            
      - name: Update dependencies
        run: |
          lake update
          
      - name: Get mathlib cache
        run: |
          lake exe cache get! || echo "Cache failed, building from source"
          
      - name: Build project
        run: |
          lake build
          
      - name: Check proofs
        run: |
          lake build Calibrator
